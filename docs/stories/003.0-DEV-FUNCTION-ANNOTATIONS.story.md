# 003.0-DEV-FUNCTION-ANNOTATIONS: Function Annotation Validation

## Release Goal

_Release 0.1: Core Validation - Provide essential ESLint rules that enforce @story and @req annotations on functions and code branches_

This story implements the core ESLint rules that validate functions have proper @story and @req annotations. It provides the fundamental traceability enforcement that ensures all functions can be traced back to their originating requirements and stories.

## How This Story Contributes

This story delivers the primary value proposition of the plugin by implementing the core validation rules for function annotations. It enables the "Write Code" journey phase by ensuring developers receive immediate feedback when they create functions without proper traceability annotations, establishing the foundation for bidirectional traceability.

## User Story

**Format**: So that I can ensure all functions in my codebase are traceable to requirements, as a Developer, I want ESLint rules that validate functions have @story and @req annotations in their JSDoc comments.

**INVEST Criteria Compliance**:

- **Independent**: Can be developed after plugin foundation and configuration (depends on 001.0, 002.0)
- **Negotiable**: Rule strictness and annotation format can be refined during implementation
- **Valuable**: Delivers core traceability enforcement for functions
- **Estimable**: Scope is clear - coordinated ESLint rules with defined behavior
- **Small**: Can be completed within a single iteration/sprint
- **Testable**: Rules can be thoroughly tested with ESLint's RuleTester

## Acceptance Criteria

Use checkbox format for clear completion tracking:

- [x] **Core Functionality**: ESLint rules `require-story-annotation` and `require-req-annotation` both enforce their respective annotations on the same set of function-like constructs, ensuring @story and @req are applied consistently together
- [x] **Quality Standards**: Rules follow ESLint rule development best practices
- [x] **Integration**: Rules work with TypeScript, JavaScript, and mixed codebases
- [x] **User Experience**: Clear, actionable error messages guide developers to fix issues
- [x] **Error Handling**: Gracefully handles malformed JSDoc comments and edge cases
- [x] **Documentation**: Rule documentation with examples and configuration options

## Requirements (Current Implementation or To Be Implemented)

Document specific technical requirements using the format:

- **REQ-FUNCTION-DETECTION**: Detect the following function-like constructs for annotation validation, shared by both rules:
  - `FunctionDeclaration`
  - `FunctionExpression`
  - `MethodDefinition`
  - `TSDeclareFunction`
  - `TSMethodSignature`
  - Arrow functions are excluded by default from traceability requirements
- **REQ-JSDOC-PARSING**: Parse JSDoc comments to extract @story and @req annotations, using a common parsing strategy for both rules
- **REQ-ANNOTATION-REQUIRED**:
  - `require-story-annotation`: Require a @story annotation on all in-scope functions
  - `require-req-annotation`: Require a @req annotation on all in-scope functions
  - Together, these rules ensure functions carry both @story and @req annotations when both rules are enabled
- **REQ-CONFIGURABLE-SCOPE**: Both rules support the same configurable scope semantics, including:
  - Which function kinds require annotations (e.g., exported only vs. all detected kinds)
  - Optional constraints based on configuration (e.g., complexity threshold, if applicable)
- **REQ-EXPORT-PRIORITY**: Both rules support a shared `exportPriority`/equivalent option so that exported functions are prioritized for enforcement over internal ones, with consistent behavior across both rules
- **REQ-ERROR-LOCATION**: Both rules report errors at the function name (or closest equivalent for anonymous constructs) for precise error location
- **REQ-TYPESCRIPT-SUPPORT**: Support TypeScript-specific function syntax and decorators, including `TSDeclareFunction` and `TSMethodSignature`, with consistent handling across both rules

## Dependencies

List other stories this story depends on, using numbered story references:

- 001.0-DEV-PLUGIN-SETUP (requires plugin structure foundation)
- 002.0-DEV-ESLINT-CONFIG (requires configuration system)

**Dependency Rules**:

- Story numbers MUST be greater than all dependency story numbers
- Dependencies should be from in-scope stories when possible
- Cross-release dependencies should be clearly justified
- No circular dependencies allowed

## Implementation Notes (Optional)

Additional context for developers:

**Development Resources**:

- See [Custom ESLint Rules Development Guide](../custom-rules-development-guide.md) for comprehensive patterns
- Review [Working with the AST](../custom-rules-development-guide.md#working-with-the-ast) for visitor patterns
- See [Accessing Source Code](../custom-rules-development-guide.md#accessing-source-code) for JSDoc comment parsing

**Implementation Details**:

- Use @typescript-eslint/utils for AST parsing to handle TypeScript syntax
- Leverage ESLint's JSDoc utilities for comment parsing via `sourceCode.getCommentsBefore()`
- Support function declarations and function expressions (excluding arrow functions), as well as `MethodDefinition`, `TSDeclareFunction`, and `TSMethodSignature`
- Consider performance impact of JSDoc parsing on large codebases
- Implement configurable options for function scope (exported only, all functions, complexity threshold)
- Handle edge cases: anonymous function expressions, IIFE, generator functions, async function declarations/expressions
- Arrow functions are explicitly excluded from traceability requirements by default
- Provide clear error messages that include function name and missing annotation type
- Keep `require-story-annotation` and `require-req-annotation` implementations aligned so that any changes to detection or scoping logic remain consistent between both rules

**Key Guide Sections**:

- [The Context Object](../custom-rules-development-guide.md#the-context-object) - Accessing sourceCode and options
- [Reporting Problems](../custom-rules-development-guide.md#reporting-problems) - Using messageIds and context.report()
- [Rule Options and Schema](../custom-rules-development-guide.md#rule-options-and-schema) - Defining configurable behavior

## Definition of Done

- [x] All acceptance criteria met
- [ ] Code reviewed and approved
- [ ] Tests written and passing (comprehensive RuleTester coverage)
- [x] Documentation updated (rule documentation with examples)
- [ ] Rule integrated into plugin configuration presets
- [ ] Performance tested with large codebases
- [ ] Ready for branch annotation rule (004.0-DEV-BRANCH-ANNOTATIONS)

---
