# 008.0-DEV-AUTO-FIX: Simple Auto-Fixes for Annotation Issues

## Release Goal

**Release 0.1: Core Validation** - Provide essential ESLint rules that enforce @story and @req annotations on functions and code branches, with validation that referenced files exist and contain the referenced requirements.

This story enables developers to automatically fix common annotation issues through ESLint's auto-fix functionality, reducing manual effort and accelerating the adoption of traceability practices by making compliance as frictionless as possible.

## How This Story Contributes

Auto-fix capabilities transform the "Fix Issues" experience from manual correction to automated resolution for common problems. This dramatically reduces the friction of maintaining traceability annotations, especially when introducing the plugin to existing codebases with many annotation violations. By providing safe, automated fixes, this story enables teams to quickly achieve compliance and focus on higher-value activities.

This story completes the core "Fix Issues" journey phase by providing both clear error messages (007.0) and automated resolution capabilities.

## User Story

**Format**: So that I can quickly resolve common annotation issues without manual editing, as a Developer, I want the ESLint plugin to automatically fix standard annotation violations when I run ESLint with the --fix option.

**INVEST Criteria Compliance**:

- **Independent**: Can be developed using existing validation logic and error reporting from previous stories
- **Negotiable**: The set of auto-fixable issues and fix strategies can be refined during implementation
- **Valuable**: Delivers clear value by reducing manual work and speeding up compliance
- **Estimable**: Scope is well-defined - implement ESLint auto-fix for specific validation rules
- **Small**: Focused on a subset of fixable issues rather than all possible violations
- **Testable**: Auto-fixes can be verified through before/after code comparisons

## Acceptance Criteria

- [x] **Core Functionality**: ESLint --fix automatically resolves common annotation violations
  - Implemented for missing `@story` on functions/methods via `require-story-annotation` and safe `@story` path suffix normalization via `valid-annotation-format`, both verified by dedicated tests (including `tests/rules/auto-fix-behavior-008.test.ts`)
- [x] **Quality Standards**: Auto-fixes are safe and preserve code functionality and formatting
  - Implemented for function/method `@story` auto-insertion and simple path suffix normalization with conservative, non-destructive edits
- [x] **Integration**: Auto-fix works properly with existing validation rules and ESLint toolchain
  - Implemented and integrated for function/method `@story` validation and basic `.story`/`.md` path suffix normalization in existing rules
- [x] **User Experience**: Fixes are applied consistently and predictably across different code patterns
  - Implemented for supported function/method patterns and simple path suffix normalization, with consistent before/after behavior validated by tests
- [x] **Error Handling**: Gracefully handles edge cases where auto-fix cannot be applied safely
  - Implemented so unfixable or ambiguous cases report validation errors without attempting a fix, focusing only on clearly safe scenarios
- [x] **Documentation**: Auto-fix capabilities are documented with examples of fixable issues
  - Implemented documentation in `user-docs/api-reference.md` for `traceability/require-story-annotation` and `traceability/valid-annotation-format`, including what `--fix` does for each rule and the safety constraints on applied fixes

## Requirements (Current Implementation or To Be Implemented)

- **REQ-AUTOFIX-MISSING**: Automatically add missing @story annotations to functions and methods using a simple built-in template via the `require-story-annotation` rule
  - Implemented for function and method annotations in this story; behavior is covered by `require-story-annotation` and verified by dedicated auto-fix tests in `tests/rules/auto-fix-behavior-008.test.ts`. The template content and formatting are currently fixed but designed for future configurability, implemented via the rule and helper functions in `src/rules/helpers/require-story-helpers.ts` and `src/rules/helpers/require-story-core.ts`.
- **REQ-AUTOFIX-FORMAT**: Fix common annotation format issues (spacing, syntax, casing) for simple, clearly identifiable cases via the `valid-annotation-format` rule
  - Implemented for simple `@story` path suffix normalization where the correct suffix (e.g., `.story.md`) can be inferred safely. Behavior is implemented via the `getFixedStoryPath` helper and the `reportInvalidStoryFormatWithFix` helper in `src/rules/valid-annotation-format.ts`, providing safe `.story`/`.md` suffix adjustments and verified by dedicated auto-fix tests in `tests/rules/auto-fix-behavior-008.test.ts`.
- **REQ-AUTOFIX-SAFE**: Only apply fixes that are guaranteed to be safe and non-destructive
  - Implemented for:
    - Adding missing `@story` annotations above functions and methods using a conservative placeholder template (`require-story-annotation`)
    - Correcting simple, unambiguous story path suffix issues limited to `.story`/`.md` suffix normalization (`valid-annotation-format`)
  - More complex or ambiguous fixes (e.g., changing directories, inferring new story names, or altering runtime code) remain explicitly out of scope for this iteration.
- **REQ-AUTOFIX-PRESERVE**: Preserve existing code formatting, indentation, and comment structure
  - Implemented for current fixes by:
    - Inserting new `@story` comments immediately above the relevant function/method without reformatting surrounding code or altering existing comments
    - Applying minimal text changes to append or correct only the `.story`/`.md` suffixes on existing path strings, preserving surrounding formatting, whitespace, and string content
  - Broader formatting or structural adjustments remain out of scope to avoid unintended changes.
- **REQ-AUTOFIX-TEMPLATE**: Use configurable annotation templates for consistent formatting
  - Not yet implemented; current behavior uses a simple, built-in placeholder template for missing `@story` annotations on functions and methods. Template configurability is planned as a future enhancement.
- **REQ-AUTOFIX-SELECTIVE**: Allow developers to choose which types of fixes to enable/disable
  - Not yet implemented; selective enable/disable of specific fix behaviors (e.g., missing-annotation vs. path-format fixes) remains future work.

## Dependencies

- 003.0-DEV-FUNCTION-ANNOTATIONS (auto-fix needs to understand function annotation requirements)
- 004.0-DEV-BRANCH-ANNOTATIONS (auto-fix needs to understand branch annotation requirements)
- 005.0-DEV-ANNOTATION-VALIDATION (auto-fix needs validation logic to identify fixable issues)
- 007.0-DEV-ERROR-REPORTING (auto-fix should integrate with error reporting for unfixable issues)

**Dependency Rules**:

- Story numbers MUST be greater than all dependency story numbers
- Dependencies should be from in-scope stories when possible
- Cross-release dependencies should be clearly justified
- No circular dependencies allowed

## Implementation Notes (Optional)

**Development Resources**:

- See [Custom ESLint Rules Development Guide](../custom-rules-development-guide.md) for fix implementation patterns
- Review [Applying Fixes](../custom-rules-development-guide.md#applying-fixes) for comprehensive fixer API documentation
- See [Best Practices](../custom-rules-development-guide.md#best-practices) for safe fix guidelines

**Technical Considerations**:

- Use ESLint's fix API to provide automated corrections
- Implement fixer functions in context.report() using fix(fixer) callback
- Set meta.fixable to "code" or "whitespace" (required for fixable rules)
- Use fixer methods: insertTextBefore(), insertTextAfter(), replaceText(), etc.
- Consider code formatting preservation using AST manipulation
- Provide configuration options for auto-fix behavior
  - NOTE: Template configurability and selective enable/disable of fix types are not yet implemented; current behavior uses a simple, built-in placeholder template for missing `@story` on functions and methods, and always applies safe, simple path suffix fixes when `valid-annotation-format` is enabled and run with `--fix`.
- Follow fix best practices: don't change runtime behavior, make minimal changes, ensure fixes are safe

**Current Auto-Fix Capabilities (This Iteration)**:

- Adding missing `@story` annotations to functions and methods with a basic placeholder template placed immediately above the function/method, implemented via the `require-story-annotation` rule
- Fixing simple story path suffix issues (e.g., adding `.story.md` when clearly missing) and other minimal, safe format corrections related to `@story` path suffixes, implemented via the `valid-annotation-format` rule

**Planned / Future Enhancements**:

- Configurable annotation templates for different project conventions
- Selective enable/disable for specific auto-fix behaviors (e.g., path fixes vs. missing-annotation fixes) beyond standard ESLint rule-level enable/disable
- Broader pattern coverage for functions and branches while maintaining safety guarantees

**Key Guide Sections**:

- [Applying Fixes](../custom-rules-development-guide.md#applying-fixes) - Complete fixer API reference and examples
- [Best Practices](../custom-rules-development-guide.md#best-practices) - Fix safety and performance guidelines

**Integration Points**:

- Enhance existing validation rules with fix capabilities
- Integrate with ESLint's --fix command line option
- Ensure compatibility with IDE auto-fix on save features
- Work with existing code formatters (Prettier, etc.)

**Safe Auto-Fix Scenarios**:

- Adding missing @story annotations with placeholder content for functions and methods (`require-story-annotation`)
- Fixing simple, unambiguous story path suffix issues (e.g., missing `.story.md`) and related minor format fixes for @story paths (`valid-annotation-format`)
- Fixing annotation comment syntax (@story vs // @story) where safe and unambiguous through `valid-annotation-format`
- Correcting annotation format spacing and structure in simple, well-understood cases
- Standardizing annotation placement (before function vs inline) for supported function/method patterns

**Non-Auto-Fixable Scenarios** (require manual intervention):

- Choosing appropriate story file references
- Adding specific requirement annotations
- Resolving file path issues that require developer knowledge
- Complex formatting conflicts with existing code style

**Testing Strategy**:

- Unit tests for each auto-fix scenario with before/after comparisons
  - Currently focused on missing-function/method-`@story` and simple path suffix issues, with dedicated coverage in `tests/rules/auto-fix-behavior-008.test.ts` alongside existing rule-specific tests
- Integration tests with various code patterns and existing formatting
- Edge case testing for complex code structures
- Manual testing with real codebases to verify safety and effectiveness

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Code reviewed and approved
- [ ] Tests written and passing
- [ ] Documentation updated
- [ ] Deployed to appropriate environment
- [ ] Stakeholder acceptance confirmed