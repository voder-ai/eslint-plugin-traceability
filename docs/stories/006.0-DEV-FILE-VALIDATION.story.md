# 006.0-DEV-FILE-VALIDATION: Story File Reference Validation

## Release Goal

_Release 0.1: Core Validation - Provide essential ESLint rules that enforce @story and @req annotations on functions and code branches_

This story implements validation logic that verifies @story annotations reference actual story files that exist in the project and have the correct .story.md extension. It completes the core file reference validation needed to ensure traceability annotations point to valid, accessible story files.

## How This Story Contributes

This story completes the "Validate Annotations" journey phase by ensuring @story references point to actual files that exist and follow the required naming convention. It prevents broken traceability links and enables confident requirement validation, bridging the gap between code annotations and their corresponding story documentation.

## User Story

**Format**: So that I can ensure my @story annotations reference valid story files, as a Developer, I want validation that checks @story file paths exist, are accessible, and follow the .story.md naming convention.

**INVEST Criteria Compliance**:

- **Independent**: Can be developed after annotation format validation (depends on 001.0-005.0)
- **Negotiable**: File validation strictness and path resolution can be refined during implementation
- **Valuable**: Delivers confidence that traceability links point to valid documentation
- **Estimable**: Scope is clear - file system validation with defined path requirements
- **Small**: Can be completed within a single iteration/sprint
- **Testable**: File validation can be tested with various file system scenarios

## Acceptance Criteria

Use checkbox format for clear completion tracking:

- [x] **Core Functionality**: Validates @story file paths reference existing .story.md files
- [x] **Quality Standards**: Follows ESLint development best practices and handles file system operations safely
- [x] **Integration**: Works with annotations validated by format validation (005.0)
- [x] **User Experience**: Clear error messages indicate which files are missing or invalid
- [x] **Error Handling**: Gracefully handles file system permissions, network drives, and edge cases
- [x] **Documentation**: File validation specification with path resolution rules and examples

## Requirements (Current Implementation or To Be Implemented)

Document specific technical requirements using the format:

- **REQ-FILE-EXISTENCE**: Verify @story file paths reference existing files
- **REQ-ERROR-HANDLING**: Gracefully handles filesystem and path validation errors and provides clear diagnostics
- **REQ-ANNOTATION-VALIDATION**: Parse and validate @story annotation lines so that file paths can be extracted reliably for validation
- **REQ-PATH-RESOLUTION**: Resolve relative paths from project root or current file location
- **REQ-SECURITY-VALIDATION**: Prevent path traversal attacks and access to restricted directories
- **REQ-PERFORMANCE-OPTIMIZATION**: Efficient file system access with caching for repeated checks
- **REQ-PROJECT-BOUNDARY**: Validate files are within project boundaries
- **REQ-CONFIGURABLE-PATHS**: Support configurable story file directories and search patterns

## Dependencies

List other stories this story depends on, using numbered story references:

- 001.0-DEV-PLUGIN-SETUP (requires plugin structure foundation)
- 002.0-DEV-ESLINT-CONFIG (requires configuration system)
- 003.0-DEV-FUNCTION-ANNOTATIONS (uses annotations detected by function validation)
- 004.0-DEV-BRANCH-ANNOTATIONS (uses annotations detected by branch validation)
- 005.0-DEV-ANNOTATION-VALIDATION (requires properly formatted annotations)

**Dependency Rules**:

- Story numbers MUST be greater than all dependency story numbers
- Dependencies should be from in-scope stories when possible
- Cross-release dependencies should be clearly justified
- No circular dependencies allowed

## Implementation Notes (Optional)

Additional context for developers:

**Development Resources**:

- See [Custom ESLint Rules Development Guide](../custom-rules-development-guide.md) for implementation patterns
- Review [The Context Object](../custom-rules-development-guide.md#the-context-object) for accessing cwd and filename
- See [Best Practices](../custom-rules-development-guide.md#best-practices) for performance optimization

**Implementation Details**:

- Use Node.js fs/promises for async file system operations (note: ESLint rules are synchronous, cache during plugin initialization)
- Implement path resolution relative to project root using `context.cwd` (where package.json/eslint.config.js exists)
- Support configurable story directories (e.g., docs/stories/, stories/, etc.) via rule options
- Cache file existence checks during single linting run for performance
- Implement security checks to prevent path traversal (../) outside project
- Handle various file system scenarios (case sensitivity, symbolic links, network drives)
- Provide helpful error messages with suggestions for fixing path issues

**Key Guide Sections**:

- [The Context Object](../custom-rules-development-guide.md#the-context-object) - Using context.cwd for path resolution
- [Reporting Problems](../custom-rules-development-guide.md#reporting-problems) - Providing helpful error messages
- [Best Practices](../custom-rules-development-guide.md#best-practices) - Caching for performance

**Path Resolution Examples:**

Valid story file references:

```javascript
// @story docs/stories/001.0-DEV-EXAMPLE.story.md
// @story stories/feature.story.md
// @story ./local-story.story.md
```

Invalid references that should trigger validation errors:

```javascript
// @story ../outside-project.story.md  (path traversal)
// @story docs/stories/missing.story.md  (file doesn't exist)
// @story docs/stories/wrong-extension.md  (wrong extension)
// @story /absolute/path.story.md  (absolute path not allowed)
```

**Configuration Integration:**

```javascript
// eslint.config.js
export default [
  {
    plugins: { traceability },
    rules: {
      "traceability/valid-story-reference": [
        "error",
        {
          storyDirectories: ["docs/stories", "stories"],
          allowAbsolutePaths: false,
          requireStoryExtension: true,
        },
      ],
    },
  },
];
```

## Definition of Done

- [x] All acceptance criteria met
- [ ] Code reviewed and approved
- [ ] Tests written and passing (file system scenarios, path resolution, security)
- [ ] Documentation updated (file validation rules and configuration options)
- [ ] Performance tested with large numbers of story files
- [ ] Security reviewed for path traversal and access control
- [x] Ready for error reporting enhancement (007.0-DEV-ERROR-REPORTING)

---