<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md</specification>
  <status>FAILED</status>
  <last_validated>2025-11-21T22:19:06.462Z</last_validated>
  <last_modified>2025-11-19T04:17:32.839Z</last_modified>
  <evidence>Story file exists:
- docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md

Implementation files for maintenance tools:
- src/maintenance/index.ts
  - Exports: detectStaleAnnotations, updateAnnotationReferences, batchUpdateAnnotations, verifyAnnotations, generateMaintenanceReport
  - JSDoc: @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md with @req REQ-MAINT-DETECT/UPDATE/BATCH/VERIFY/REPORT/SAFE
- src/maintenance/detect.ts
  - detectStaleAnnotations(codebasePath: string): string[]
  - Uses getAllFiles to traverse codebasePath
  - Regex /@story\s+([^\s]+)/g to extract story paths
  - Marks a story as stale if it does not exist at either path.resolve(cwd, storyPath) or path.resolve(baseDir, storyPath)
  - Returns unique list of stale story paths; returns [] when codebasePath does not exist or is not a directory
- src/maintenance/update.ts
  - updateAnnotationReferences(codebasePath, oldPath, newPath): number
  - Validates codebasePath exists and is a directory; otherwise returns 0
  - Escapes oldPath and builds RegExp '(@story\\s*)' + escapedOldPath
  - Iterates getAllFiles(codebasePath), skips non-files
  - Replaces matches with callback (match, p1) => { replacementCount++; return p1 + newPath }
  - Writes back only if content changed; returns replacementCount
- src/maintenance/batch.ts
  - batchUpdateAnnotations(codebasePath, mappings[]): number
    - Sums updateAnnotationReferences over mappings; implements batch updates
  - verifyAnnotations(codebasePath): boolean
    - Uses detectStaleAnnotations and returns true when no stale annotations found
- src/maintenance/report.ts
  - generateMaintenanceReport(codebasePath): string
    - Calls detectStaleAnnotations
    - Returns "" when no stale annotations; otherwise joins stale story paths with newlines
- src/maintenance/utils.ts
  - getAllFiles(dir: string): string[]
    - Validates dir exists/is directory; otherwise returns []
    - Recursively traverses directories, collecting regular file paths only

Tests explicitly tied to this story:
- tests/maintenance/detect.test.ts (@story 009.0, @req REQ-MAINT-DETECT)
  - Ensures detectStaleAnnotations returns [] when there are no annotations
  - Ensures it detects a stale @story reference in a single file
- tests/maintenance/detect-isolated.test.ts (@story 009.0, @req REQ-MAINT-DETECT)
  - Returns [] for non-existent directory
  - Detects two stale annotations in nested directories
  - Expects detectStaleAnnotations to throw on permission-denied directory (no graceful handling)
- tests/maintenance/update.test.ts (@story 009.0, @req REQ-MAINT-UPDATE)
  - Returns 0 when no updates are made in an empty temp directory
- tests/maintenance/update-isolated.test.ts (@story 009.0, @req REQ-MAINT-UPDATE)
  - Updates '@story old.path.md' to '@story new.path.md' and returns count = 1
  - Returns 0 when directory does not exist
- tests/maintenance/batch.test.ts (@story 009.0, @req REQ-MAINT-BATCH, REQ-MAINT-VERIFY)
  - batchUpdateAnnotations(tmpDir, []) returns 0
  - verifyAnnotations(tmpDir) returns true when a matching story file exists
- tests/maintenance/report.test.ts (@story 009.0, @req REQ-MAINT-REPORT, REQ-MAINT-SAFE)
  - generateMaintenanceReport(tmpDir) returns "" when no stale annotations
  - Reports 'non-existent.md' when a stale @story reference is present
- tests/maintenance/index.test.ts
  - Confirms that all maintenance functions are exported from src/maintenance as functions

Targeted test execution for this story:
- Command:
  npm test -- --ci --no-watch --runInBand --verbose --runTestsByPath \
    tests/maintenance/detect.test.ts \
    tests/maintenance/update.test.ts \
    tests/maintenance/batch.test.ts \
    tests/maintenance/report.test.ts \
    tests/maintenance/index.test.ts \
    tests/maintenance/detect-isolated.test.ts \
    tests/maintenance/update-isolated.test.ts
- This command completed without Jest failure output or runner errors, indicating these suites passed.

Missing or incomplete aspects versus acceptance criteria:
- No CLI or npm script exposes these maintenance tools; they are only available as internal library functions (no direct developer-facing tool as described in the story).
- No integration with ESLint configuration or plugin entry (src/index.ts) beyond sharing traceability concepts; maintenance operations are not part of any configured workflow or script.
- User feedback is minimal:
  - updateAnnotationReferences and batchUpdateAnnotations only return counts
  - generateMaintenanceReport only lists stale story paths, not which files/annotations were updated or why
  - No structured reporting or clear UX for developers
- Error handling:
  - Missing directories handled gracefully (return [] / 0)
  - Permission-denied directory explicitly causes detectStaleAnnotations to throw and is tested as such (not graceful)
  - No explicit handling or tests for circular references
- Safety and reversibility (REQ-MAINT-SAFE):
  - No backup, dry-run, or rollback mechanisms implemented
  - No change logs or artifacts to support reversing operations
- Documentation:
  - README.md contains no references to 'maintenance' or these tools
  - docs/ contains only the story file for 009.0; no guide, usage examples, or best practices for maintenance tools are documented
  - No documented CLI or programmatic usage examples
</evidence>
  <notes>The codebase contains a fairly complete internal implementation of maintenance utilities (detection, update, batch operations, verification, and reporting), along with comprehensive unit tests that pass. However, key acceptance criteria are not fully met: there is no CLI or integrated tool exposed to users, user experience and feedback about changes are minimal, error handling is not fully graceful for all edge cases (e.g., permission-denied directories, circular references), safety and reversibility mechanisms are not implemented, and there is no documentation describing how to use these maintenance tools. Because these gaps directly violate the story's Acceptance Criteria and Definition of Done, this story is assessed as FAILED rather than PASSED.</notes>
</traceability>