<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md</specification>
  <status>FAILED</status>
  <last_validated>2025-11-21T01:28:48.481Z</last_validated>
  <last_modified>2025-11-19T04:17:32.839Z</last_modified>
  <evidence>Story file:
- docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md exists and defines:
  - Acceptance criteria for core functionality, quality, integration, user experience, error handling, and documentation.
  - Requirements REQ-MAINT-DETECT, REQ-MAINT-UPDATE, REQ-MAINT-BATCH, REQ-MAINT-VERIFY, REQ-MAINT-REPORT, REQ-MAINT-SAFE.

Implemented maintenance tools (source code):
- src/maintenance/index.ts
  - Exports maintenance helpers:
    - detectStaleAnnotations from "./detect"
    - updateAnnotationReferences from "./update"
    - batchUpdateAnnotations, verifyAnnotations from "./batch"
    - generateMaintenanceReport from "./report"
  - File-level traceability:
    - @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md
    - @req REQ-MAINT-DETECT / REQ-MAINT-UPDATE / REQ-MAINT-BATCH / REQ-MAINT-VERIFY / REQ-MAINT-REPORT / REQ-MAINT-SAFE

- src/maintenance/detect.ts
  - Function: export function detectStaleAnnotations(codebasePath: string): string[]
  - Behavior:
    - Returns [] if codebasePath does not exist or is not a directory.
    - Uses getAllFiles(codebasePath) to recursively collect files.
    - Scans each file with regex /@story\s+([^\s]+)/g to find @story annotations.
    - For each storyPath found, resolves:
      - storyProjectPath = path.resolve(cwd, storyPath)
      - storyCodebasePath = path.resolve(baseDir, storyPath)
      and if both are missing, adds storyPath to a Set of stale references.
    - Returns Array.from(stale).
  - Traceability:
    - @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md
    - @req REQ-MAINT-DETECT - Detect stale annotation references

- src/maintenance/update.ts
  - Function: export function updateAnnotationReferences(codebasePath: string, oldPath: string, newPath: string): number
  - Behavior:
    - Returns 0 if codebasePath does not exist or is not a directory.
    - Builds escapedOldPath and regex: new RegExp(`(@story\\s*)${escapedOldPath}`, "g").
    - Iterates all files from getAllFiles(codebasePath), skipping non-regular files.
    - Uses String.replace with callback (match, p1) to replace '@story oldPath' with '@story newPath', incrementing replacementCount.
    - Writes file back only when content changed, preserving formatting elsewhere.
    - Returns replacementCount.
  - Traceability comments link to REQ-MAINT-UPDATE for validation and replacement logic.

- src/maintenance/batch.ts
  - Functions:
    - export function batchUpdateAnnotations(codebasePath: string, mappings: { oldPath: string; newPath: string }[]): number
      - Iterates mappings and sums updateAnnotationReferences(codebasePath, oldPath, newPath) into totalUpdated, returns totalUpdated.
    - export function verifyAnnotations(codebasePath: string): boolean
      - Calls detectStaleAnnotations(codebasePath) and returns staleAnnotations.length === 0.
  - Traceability:
    - @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md
    - @req REQ-MAINT-BATCH - Perform batch updates
    - @req REQ-MAINT-VERIFY - Verify annotation references

- src/maintenance/report.ts
  - Function: export function generateMaintenanceReport(codebasePath: string): string
  - Behavior:
    - Calls detectStaleAnnotations(codebasePath).
    - If no stale annotations, returns "".
    - Otherwise returns staleAnnotations.join("\n"), i.e., newline-separated report of stale story paths.
  - Traceability:
    - @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md
    - @req REQ-MAINT-REPORT - Generate maintenance report
    - @req REQ-MAINT-SAFE - Ensure operations are safe and reversible (this function is read-only and does not mutate code).

- src/maintenance/utils.ts
  - Function: export function getAllFiles(dir: string): string[]
  - Behavior:
    - If dir does not exist or is not a directory, returns [].
    - Recursively traverses directory tree with readdirSync and statSync.
    - Recurses into subdirectories; collects only regular files (skips non-files).
  - Used by detectStaleAnnotations and updateAnnotationReferences to safely traverse codebases.
  - JSDoc includes @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md and several REQ-MAINT-UTILS* requirements (internal helpers for this story).

Tests for Story 009.0 (with explicit story/req traceability):
- tests/maintenance/index.test.ts
  - Header:
    - Tests for: docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md
    - @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md
    - @req REQ-MAINT-SAFE - Ensure all maintenance tools are exported correctly
  - Asserts that each maintenance function is exported and is typeof "function":
    - detectStaleAnnotations
    - updateAnnotationReferences
    - batchUpdateAnnotations
    - verifyAnnotations
    - generateMaintenanceReport

- tests/maintenance/detect.test.ts
  - Header references story 009.0 and @req REQ-MAINT-DETECT.
  - Tests:
    - "[REQ-MAINT-DETECT] should return empty array when no stale annotations": uses empty temp directory, expects [].
    - "[REQ-MAINT-DETECT] should detect stale annotation references": writes a file with @story stale.story.md, expects result length 1 and toContain("stale.story.md").

- tests/maintenance/detect-isolated.test.ts
  - Header references story 009.0 and REQ-MAINT-DETECT.
  - Tests additional edge cases:
    - Non-existent directory -> detectStaleAnnotations("non-existent-dir") returns [].
    - Nested directories containing two files with different stale @story values -> expects length 2 and contains both story names.
    - Permission-denied directory: chmod 000 on subdir and expects detectStaleAnnotations(tmpDir2) to throw; then restores permissions and cleans up.

- tests/maintenance/update.test.ts
  - Header references story 009.0 and REQ-MAINT-UPDATE.
  - Test:
    - "[REQ-MAINT-UPDATE] should return 0 when no updates made": empty temp dir, calls updateAnnotationReferences(tmpDir, "old.md", "new.md"), expects 0.

- tests/maintenance/update-isolated.test.ts
  - Header references story 009.0 and REQ-MAINT-UPDATE.
  - Tests:
    - "[REQ-MAINT-UPDATE] updates @story annotations in files": writes a file containing @story old.path.md, calls updateAnnotationReferences(tmpDir, "old.path.md", "new.path.md"), expects count === 1 and file content to contain "@story new.path.md".
    - "[REQ-MAINT-UPDATE] should return 0 when directory does not exist": calls updateAnnotationReferences("non-existent-dir", ...), expects 0.

- tests/maintenance/batch.test.ts
  - Header references story 009.0, REQ-MAINT-BATCH, and REQ-MAINT-VERIFY.
  - Tests:
    - "[REQ-MAINT-BATCH] should return 0 when no mappings applied": batchUpdateAnnotations(tmpDir, []), expects 0.
    - For verifyAnnotations:
      - Sets up tmpDir with test.ts referencing my-story.story.md and creates my-story.story.md.
      - "[REQ-MAINT-VERIFY] should return true when annotations are valid": expects verifyAnnotations(tmpDir) === true.

- tests/maintenance/report.test.ts
  - Header references story 009.0, REQ-MAINT-REPORT, REQ-MAINT-SAFE.
  - Tests:
    - "[REQ-MAINT-REPORT] should return empty string when no operations": tmpDir with no stale annotations, generateMaintenanceReport(tmpDir) === "".
    - "[REQ-MAINT-REPORT] should report stale story annotation": writes file with @story non-existent.md and expects generateMaintenanceReport(tmpDir) to contain "non-existent.md".

Test execution evidence:
- Tool run:
  - npm test -- --runInBand --verbose
  - Under the hood: jest --ci --bail --runInBand --verbose
- Output (truncated in this context) shows Jest running with verbose mode and debug logs; no failures were reported by the command wrapper, indicating tests for maintenance tools pass successfully.

Documentation and user-facing usage evidence:
- README.md:
  - Describes eslint-plugin-traceability, installation, ESLint rules, and how to run tests.
  - No mention of maintenance tools (detectStaleAnnotations, updateAnnotationReferences, batchUpdateAnnotations, verifyAnnotations, generateMaintenanceReport).
- user-docs/api-reference.md:
  - Documents ESLint rules and configuration presets only.
  - No API documentation for maintenance helpers.
- user-docs/examples.md:
  - Provides ESLint configuration and CLI usage examples.
  - No examples of running maintenance operations or batch updates.
- docs/jest-testing-guide.md:
  - Includes an example verbose Jest output snippet showing maintenance tests (batchUpdateAnnotations, verifyAnnotations) to demonstrate traceability in test output.
  - This is framed as a testing guide, not as user-facing documentation for running maintenance tools in real workflows.
- No dedicated markdown file or section (in docs/ or user-docs/) that:
  - Explains maintenance tool purposes and typical scenarios (story moves/renames, deletions, bulk renumbering).
  - Shows how to invoke them via CLI or programmatic API in consuming projects.
  - Provides best practices for safe usage (e.g., running under version control, dry runs, integration with git hooks).

Integration surface evidence:
- src/index.ts exports ESLint rules and configs only; it does not export maintenance helpers.
- No CLI script or npm script dedicated to maintenance operations is present in package.json.
- Maintenance helpers are currently internal modules used directly by tests only; they are not yet integrated into a public-facing API or tooling surface.</evidence>
  <notes>Most of the functional requirements of story 009.0-DEV-MAINTENANCE-TOOLS are implemented and tested:
- REQ-MAINT-DETECT: detectStaleAnnotations scans the codebase for @story references to non-existent story files, with thorough tests including empty dirs, nested dirs, and permission errors.
- REQ-MAINT-UPDATE: updateAnnotationReferences updates @story paths from oldPath to newPath in-place with minimal changes, and tests confirm both successful updates and safe no-op behavior when directories do not exist or no matches are present.
- REQ-MAINT-BATCH: batchUpdateAnnotations performs batch updates over a list of mappings, with tests verifying behavior when mappings are empty; combined with updateAnnotationReferences this covers the batch update requirement.
- REQ-MAINT-VERIFY: verifyAnnotations uses detectStaleAnnotations to confirm there are no stale references; tests cover the case where annotations and story files are consistent.
- REQ-MAINT-REPORT: generateMaintenanceReport builds a newline-separated report of stale story annotations, with tests for both empty and non-empty states.
- REQ-MAINT-SAFE: safety is partially addressed through defensive checks (non-existent dirs return safe defaults), selective file writes only when content changes, and read-only reporting; tests exercise these behaviors.

The acceptance criteria that require correct behavior, preservation of functionality/formatting, and clear programmatic feedback are therefore largely met at the code and test level. However, the story also has an explicit acceptance criterion for **Documentation**: "Maintenance tools are documented with usage examples and best practices." There is currently no dedicated documentation describing how developers should use these maintenance tools in their projects, no CLI or API usage examples in user documentation, and no best-practices guidance for common maintenance workflows. The only mentions of these tools appear in a Jest testing guide focused on test output, not on user usage.

Because this documentation criterion is not met, the story is not fully complete according to its own acceptance criteria. Therefore the overall assessment for this story is FAILED.</notes>
</traceability>