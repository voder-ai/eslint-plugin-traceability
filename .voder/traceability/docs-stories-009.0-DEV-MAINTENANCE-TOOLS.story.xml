<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md</specification>
  <status>FAILED</status>
  <last_validated>2025-11-21T07:33:42.042Z</last_validated>
  <last_modified>2025-11-19T04:17:32.839Z</last_modified>
  <evidence>1) Story and tests linkage:
- Story file exists: docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md.
- Multiple tests explicitly reference this story via @story annotations:
  - tests/maintenance/index.test.ts
  - tests/maintenance/detect.test.ts
  - tests/maintenance/detect-isolated.test.ts
  - tests/maintenance/update.test.ts
  - tests/maintenance/update-isolated.test.ts
  - tests/maintenance/batch.test.ts
  - tests/maintenance/report.test.ts.

2) Implemented maintenance tools (src/maintenance/*.ts):
- src/maintenance/index.ts:
  - Exports: detectStaleAnnotations, updateAnnotationReferences, batchUpdateAnnotations, verifyAnnotations, generateMaintenanceReport.
  - JSDoc:
    - @story docs/stories/009.0-DEV-MAINTENANCE-TOOLS.story.md
    - @req REQ-MAINT-DETECT, REQ-MAINT-UPDATE, REQ-MAINT-BATCH, REQ-MAINT-VERIFY, REQ-MAINT-REPORT, REQ-MAINT-SAFE.

- src/maintenance/detect.ts (REQ-MAINT-DETECT):
  - detectStaleAnnotations(codebasePath: string): string[]
  - If codebasePath does not exist or is not a directory, returns [].
  - Uses getAllFiles(codebasePath) to iterate all files.
  - Regex /@story\s+([^\s]+)/g to find @story annotations.
  - For each storyPath, computes two possible locations:
    - project-root-relative: path.resolve(process.cwd(), storyPath)
    - codebase-relative: path.resolve(baseDir, storyPath)
  - If the story file exists in neither location, adds storyPath to a Set.
  - Returns Array.from(stale).

- src/maintenance/update.ts (REQ-MAINT-UPDATE):
  - updateAnnotationReferences(codebasePath, oldPath, newPath): number
  - If codebasePath does not exist or is not a directory, returns 0.
  - Escapes oldPath for regex and builds /(@story\s*)<oldPath>/g.
  - Uses getAllFiles(codebasePath), skips non-files.
  - Replaces matches using a callback that increments replacementCount and substitutes newPath.
  - Writes file back only if content changed.
  - Returns replacementCount.

- src/maintenance/batch.ts (REQ-MAINT-BATCH, REQ-MAINT-VERIFY):
  - batchUpdateAnnotations(codebasePath, mappings[]):
    - Loops over mappings {oldPath, newPath}, sums calls to updateAnnotationReferences.
    - Returns totalUpdated.
  - verifyAnnotations(codebasePath: string): boolean
    - Calls detectStaleAnnotations(codebasePath) and returns true if length === 0.

- src/maintenance/report.ts (REQ-MAINT-REPORT, REQ-MAINT-SAFE):
  - generateMaintenanceReport(codebasePath: string): string
  - Calls detectStaleAnnotations(codebasePath).
  - If no stale annotations, returns empty string "".
  - Otherwise, returns staleAnnotations.join("\n").

- src/maintenance/utils.ts (shared helper):
  - getAllFiles(dir: string): string[]
  - Validates dir exists and is a directory; otherwise returns [].
  - Recursively walks directories with fs.readdirSync and fs.statSync, collecting regular file paths only.
  - Used by detect.ts and update.ts.

3) Test coverage for requirements:
- tests/maintenance/index.test.ts:
  - Asserts each maintenance function is exported and is a function.
  - @req REQ-MAINT-SAFE for ensuring correct exports.

- tests/maintenance/detect.test.ts and detect-isolated.test.ts (REQ-MAINT-DETECT):
  - No-stale case: empty temp dir -> detectStaleAnnotations(tmpDir) returns [].
  - Simple stale case: file with "@story stale.story.md" and no such story file -> result length 1 and contains "stale.story.md".
  - Non-existent directory -> returns [].
  - Nested directories with two stale stories -> result contains both paths.
  - Permission-denied directory: after chmod 000 on a subdir, expect detectStaleAnnotations(tmpDir) to throw, verifying error-handling behavior.

- tests/maintenance/update.test.ts and update-isolated.test.ts (REQ-MAINT-UPDATE):
  - Empty directory -> updateAnnotationReferences(tmpDir, "old.md", "new.md") returns 0.
  - Actual update: file containing "@story old.path.md"; after updateAnnotationReferences(tmpDir, "old.path.md", "new.path.md"), count is 1 and file content contains "@story new.path.md".
  - Non-existent directory -> returns 0.

- tests/maintenance/batch.test.ts (REQ-MAINT-BATCH, REQ-MAINT-VERIFY):
  - batchUpdateAnnotations(tmpDir, []) returns 0 (no-op batch).
  - verifyAnnotations(tmpDir) returns true when a story file and its referencing annotation both exist in tmpDir.

- tests/maintenance/report.test.ts (REQ-MAINT-REPORT, REQ-MAINT-SAFE):
  - No operations: generateMaintenanceReport(tmpDir) returns "".
  - With a file containing "@story non-existent.md" and no such story file, report string contains "non-existent.md".

4) Test execution:
- npm test -- --runInBand --verbose was run.
- Jest executed with --ci --bail --runInBand --verbose.
- Output shows debug logs from existing rules but no test failures; the maintenance tests are part of the suite and pass.

5) Gaps vs Acceptance Criteria:
- Core Functionality: Implemented and tested.
  - Tools detect stale annotation references, update them (single and batch), and verify annotations; also produce a textual report of stale references.
- Quality Standards: Partially satisfied.
  - updateAnnotationReferences only touches files when content changes and uses a targeted regex around '@story'.
  - getAllFiles uses straightforward recursive traversal.
  - However, there are no tests explicitly asserting that code formatting is preserved beyond the specific replacement; the logic is simple string replacement, not AST-based, so formatting is preserved implicitly but not strongly guaranteed.
- Integration: Only partial.
  - Tools live under src/maintenance and are exported via src/maintenance/index.ts, but:
    - src/index.ts (the plugin's main export) does not expose these maintenance APIs.
    - package.json has no npm scripts or CLI entry points for these tools.
    - No ESLint config integration or workflow integration is described or wired up.
  - They are usable programmatically, but not obviously integrated into the “existing project structure and ESLint configuration” from a user’s perspective.
- User Experience: Partially addressed.
  - generateMaintenanceReport provides a textual list of stale annotations; batch/update functions return numeric counts.
  - Error handling (non-existent dirs, permission issues) is covered by tests.
  - However, there is no CLI, no human-friendly messages, no logging, and no guidance on how developers should invoke these tools in real workflows.
- Error Handling: Partially addressed.
  - Non-existent directories for detect/update/batch/verify produce safe defaults (empty results or zero updates).
  - Permission-denied scenarios are explicitly tested to ensure detectStaleAnnotations throws, but there is no higher-level error-reporting abstraction or mapping to the “007.0-DEV-ERROR-REPORTING” story beyond basic thrown errors.
  - No handling for more complex edge cases like circular references (though these may be less relevant to file-path-based @story annotations).
- Documentation: Not implemented.
  - No usage documentation for these tools was found:
    - README.md contains no references to "maintenance" or the function names like detectStaleAnnotations.
    - docs/custom-rules-development-guide.md has no mentions of maintenance tools.
    - No dedicated user or developer guide exists describing how to run these maintenance utilities, recommended workflows, or best practices.
  - The only documentation is the story file itself and inline JSDoc comments, which does not satisfy the acceptance criterion: "Maintenance tools are documented with usage examples and best practices."
- REQ-MAINT-SAFE (reversibility): Partially covered only by using safe defaults and non-destructive detection/reporting.
  - There is no implementation of explicit reversibility mechanisms (e.g., backup files, dry-run mode, automatic rollback).
  - In practice, users would have to rely on version control for rollback; this is not mentioned or encoded anywhere.

Given these observations, the core code and tests for detection, update, batch, verify, and reporting are in place and passing, but at least two acceptance criteria (Documentation and fuller Integration/User Experience/Safety expectations) are not satisfied.</evidence>
  <notes>Story 009.0-DEV-MAINTENANCE-TOOLS is only partially implemented. There is solid implementation and test coverage for the core maintenance operations: detecting stale @story references, updating them singly and in batch, verifying annotations, and generating a basic report. These functions are properly exported from src/maintenance/index.ts, use shared traversal utilities, and are explicitly linked to this story via @story/@req annotations. Jest tests targeting this story pass and verify both happy paths and several edge cases (non-existent directories, nested folders, and permission-denied errors). However, the acceptance criteria require more than just core behavior: they call for clear documentation with usage examples and best practices, and better integration and user experience around how developers should actually use these tools in their workflow. The repository currently lacks any README or docs content describing these maintenance APIs, has no npm scripts or CLI wrapper exposing them, and does not provide explicit reversibility mechanisms beyond relying on external version control. Because Documentation and parts of Integration/User Experience/Safety are not met, the story cannot be considered fully done and is marked as FAILED.</notes>
</traceability>