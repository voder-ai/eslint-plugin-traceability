<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T00:23:30.483Z</last_validated>
  <last_modified>2025-11-19T04:17:32.767Z</last_modified>
  <evidence>Implementation:
- Rule file: src/rules/require-branch-annotation.ts
  - ESLint RuleModule named require-branch-annotation.
  - Meta:
    - type: "problem";
    - docs.description: "Require @story and @req annotations on code branches";
    - messages.missingAnnotation: "Missing {{missing}} annotation on code branch";
    - schema supports an options object with a branchTypes array.
  - create(context):
    - Calls validateBranchTypes(context).
    - If validateBranchTypes returns a RuleListener (invalid config case), it returns that directly.
    - Otherwise, iterates branchTypes and registers handlers for each AST node type; each handler calls reportMissingAnnotations(context, node, storyFixCountRef).
  - File-level JSDoc:
    - @story docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md
    - @req REQ-BRANCH-DETECTION, @req REQ-CONFIGURABLE-SCOPE.

Helpers:
- src/utils/branch-annotation-helpers.ts
  - DEFAULT_BRANCH_TYPES:
    - ["IfStatement", "SwitchCase", "TryStatement", "CatchClause", "ForStatement", "ForOfStatement", "ForInStatement", "WhileStatement", "DoWhileStatement"].
    - JSDoc links to story 004.0 and REQ-SIGNIFICANCE-CRITERIA.
  - validateBranchTypes(context):
    - Reads context.options[0] (if present).
    - If options.branchTypes is an array:
      - Filters against DEFAULT_BRANCH_TYPES using isInvalidType.
      - If invalidTypes.length > 0, returns a RuleListener with a Program handler.
        - Program handler reports for each invalid type with message `Value "${t}" should be equal to one of the allowed values: ${DEFAULT_BRANCH_TYPES.join(", ")}`.
      - If none invalid, returns options.branchTypes as BranchType[].
    - If no branchTypes provided, returns DEFAULT_BRANCH_TYPES.
    - This realizes REQ-CONFIGURABLE-SCOPE and the specified invalid configuration behavior.
  - gatherBranchCommentText(sourceCode, node):
    - For SwitchCase: inspects up to PRE_COMMENT_OFFSET (2) lines above node.loc.start.line and collects lines that start with // or /*; returns joined string.
    - For other nodes: uses sourceCode.getCommentsBefore(node), maps to comment.value, and joins.
    - JSDoc cites REQ-COMMENT-ASSOCIATION and SwitchCase-specific handling.
  - reportMissingStory(context, node, { indent, insertPos, storyFixCountRef }):
    - If storyFixCountRef.count === 0:
      - Reports with messageId "missingAnnotation", data { missing: "@story" }, and a fixer that inserts `${indent}// @story <story-file>.story.md\n` at insertPos.
      - Increments storyFixCountRef.count.
    - Else: reports without fixer.
    - Supports auto-fix behavior and UX.
  - reportMissingReq(context, node, { indent, insertPos, missingStory }):
    - If !missingStory:
      - Reports with fixer inserting `${indent}// @req <REQ-ID>\n`.
    - Else: reports without fixer.
  - reportMissingAnnotations(context, node, storyFixCountRef):
    - Obtains sourceCode and commentText via gatherBranchCommentText.
    - missingStory = !/@story\b/.test(text), missingReq = !/@req\b/.test(text).
    - Computes indent from leading whitespace of branch line; compute insertPos via getIndexFromLoc.
    - Constructs actions array describing whether @story/@req are missing and corresponding handler + args, then forEach over actions to run handlers.
    - JSDoc references REQ-ANNOTATION-PARSING and nested/complex handling.

Tests for rule behavior:
- tests/rules/require-branch-annotation.test.ts
  - Header:
    - "Tests for: docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md".
    - @story docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md.
    - @req REQ-BRANCH-DETECTION - Verify require-branch-annotation rule enforces branch annotations.
  - Uses eslint RuleTester with ecmaVersion 2020.
  - describe("Require Branch Annotation Rule (Story 004.0-DEV-BRANCH-ANNOTATIONS)", ...).
  - ruleTester.run with many valid cases:
    - IfStatement with preceding // @story and // @req.
    - ForStatement, While, DoWhile, ForOf, ForIn loops with block comments containing @story and @req.
    - SwitchCase with inline comments on the case and tests for a blank-line-before-case scenario (exercises SwitchCase scanning).
    - try / finally, try / catch with appropriate annotations.
    - Config tests:
      - options: [{ branchTypes: ["IfStatement"] }] to show that SwitchCase is ignored when not listed.
      - options: [{ branchTypes: ["IfStatement", "SwitchCase"] }] verifying enforcement only on configured types.
  - Invalid cases assert both errors and auto-fix outputs:
    - Missing annotations on if:
      - code: `if (condition) {}`.
      - output: `// @story <story-file>.story.md\nif (condition) {}`.
      - errors: missing @story, missing @req.
    - Missing req when only @story present, e.g. for loop with only @story comment; output adds // @req <REQ-ID>.
    - Missing story when only @req present, while loop; output adds // @story <story-file>.story.md.
    - Missing annotations on switch-case (including with blank line before case), do-while, for-of, for-in, and try/catch blocks; outputs insert @story and rely on error list for both @story and @req.
    - Config error test:
      - options: [{ branchTypes: ["UnknownType"] }].
      - Expects errors with message matching /should be equal to one of the allowed values/ (validates invalid configuration handling from validateBranchTypes).

Helper unit tests:
- tests/utils/branch-annotation-helpers.test.ts
  - Header mentions story 004.0 and REQ-CONFIGURABLE-SCOPE.
  - Tests validateBranchTypes behavior:
    - No options: returns DEFAULT_BRANCH_TYPES.
    - Valid custom branchTypes: returns exactly those.
    - Invalid custom branchTypes: returns an object with Program property; calling Program(fakeNode) calls context.report once per invalid type, with message containing `Value "${t}" should be equal to one of the allowed values:`. This matches the story’s invalid configuration behavior requirement.

Documentation:
- docs/rules/require-branch-annotation.md
  - Description: "Ensures that significant code branches (if/else, switch cases, loops, try/catch) have `@story` and `@req` annotations for traceability." (matches story intent).
  - Annotations:
    - @story docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md.
    - @req REQ-BRANCH-DETECTION, @req REQ-CONFIGURABLE-SCOPE.
  - Describes that the rule checks JSDoc or inline comments immediately preceding branches for both annotations.
  - Options section:
    - Documents branchTypes, its default, and allowed values equal to DEFAULT_BRANCH_TYPES.
    - States that invalid values produce an error: Value "InvalidType" should be equal to one of the allowed values (aligned with implementation and tests).
  - Provides correct/incorrect examples and configuration snippet.

Integration:
- src/index.ts
  - RULE_NAMES array includes "require-branch-annotation".
  - Dynamic loading uses require(`./rules/${name}`), so require-branch-annotation.ts is loaded as a rule module.
  - configs.recommended and configs.strict each set:
    - "traceability/require-branch-annotation": "error".
  - This integrates the rule into plugin presets as required by the Definition of Done.

Story presence and traceability:
- docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md exists.
- Implementation files and tests reference this story path via @story tags.
- Test names include prefixes like [REQ-BRANCH-DETECTION] and [REQ-CONFIGURABLE-SCOPE], aligning with documented requirements.

Test execution:
- Command run: npm test -- --ci --no-watch --runInBand --verbose.
- package.json: "test": "jest --ci --bail".
- The command executed Jest with --ci, --bail, --no-watch, --runInBand, --verbose.
- Output shows only console.debug logs from other rules and no Jest error summary or failures; the command completed successfully, so tests for require-branch-annotation and branch-annotation-helpers passed.</evidence>
  <notes>All acceptance criteria for 004.0-DEV-BRANCH-ANNOTATIONS are satisfied. The require-branch-annotation rule detects significant branch nodes (if/else, switch, loops, try/catch) and checks for @story and @req annotations using helper utilities. It supports configurable branchTypes and reports clear errors when configuration is invalid. Tests comprehensively cover valid and invalid patterns across all branch types, including nested and edge cases (e.g., switch cases with blank lines), and validate auto-fix behavior and configuration error handling. The rule is integrated into the plugin’s recommended and strict configs and has dedicated documentation with examples and configuration guidance. All Jest tests, including those for this rule and its helpers, pass. Therefore, this story’s implementation is complete and marked as PASSED.</notes>
</traceability>