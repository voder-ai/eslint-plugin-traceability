<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T02:42:43.645Z</last_validated>
  <last_modified>2025-11-19T04:17:32.767Z</last_modified>
  <evidence>Implementation files:
- src/rules/require-branch-annotation.ts
  - ESLint RuleModule enforcing @story and @req on branches.
  - JSDoc:
    * @story docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md
    * @req REQ-BRANCH-DETECTION, REQ-CONFIGURABLE-SCOPE
  - meta:
    * type: "problem"
    * docs.description: "Require @story and @req annotations on code branches"
    * fixable: "code"
    * messages.missingAnnotation: "Missing {{missing}} annotation on code branch"
    * schema supports { branchTypes: string[] } with validation
  - create(context):
    * Calls validateBranchTypes(context). If invalid config, returns a listener that reports configuration errors.
    * For each valid branch type, registers a handler that (except default SwitchCase) calls reportMissingAnnotations(context, node, storyFixCountRef).

- src/utils/branch-annotation-helpers.ts
  - DEFAULT_BRANCH_TYPES constant:
    * ["IfStatement", "SwitchCase", "TryStatement", "CatchClause", "ForStatement", "ForOfStatement", "ForInStatement", "WhileStatement", "DoWhileStatement"]
    * JSDoc: @story docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md, @req REQ-SIGNIFICANCE-CRITERIA.
  - validateBranchTypes(context) (JSDoc @req REQ-CONFIGURABLE-SCOPE):
    * Reads options[0].branchTypes.
    * If branchTypes is array, filters out invalid entries via DEFAULT_BRANCH_TYPES.includes.
    * If invalid types exist, returns { Program(node) { ... } } listener:
      - Program reports for each invalid type with message:
        `Value "${t}" should be equal to one of the allowed values: ${DEFAULT_BRANCH_TYPES.join(", ")}`
      - Matches story’s invalid configuration behavior requirement.
    * If all valid, returns branchTypes; otherwise returns DEFAULT_BRANCH_TYPES when no option provided.
  - gatherBranchCommentText(sourceCode, node) (JSDoc @req REQ-COMMENT-ASSOCIATION):
    * For SwitchCase: inspects up to 2 lines above node.loc.start.line, collecting lines starting with // or /* and returns them concatenated.
    * For other branch types: uses sourceCode.getCommentsBefore(node), maps to .value, and joins.
    * This associates inline and preceding comments with their code branches, including special handling for switch cases.
  - reportMissingStory(...) and reportMissingReq(...):
    * JSDoc marks @req REQ-ANNOTATION-PARSING.
    * When missing, report diagnostics with messageId "missingAnnotation" and data { missing: "@story" | "@req" }.
    * Offer auto-fixers:
      - story: inserts `${indent}// @story <story-file>.story.md\n` once per file (controlled by storyFixCountRef.count).
      - req: inserts `${indent}// @req <REQ-ID>\n` when story exists.
  - reportMissingAnnotations(context, node, storyFixCountRef):
    * text = gatherBranchCommentText(...);
    * missingStory = !/@story\b/.test(text), missingReq = !/@req\b/.test(text).
    * Derives indent and insertPos from sourceCode and node.loc.
    * Builds actions array for story/req and forEach(processAction) to call reportMissingStory/reportMissingReq only when missing.

Integration:
- src/index.ts
  - RULE_NAMES includes "require-branch-annotation".
  - Dynamic loader requires ./rules/require-branch-annotation and adds to rules map.
  - configs.recommended and configs.strict both enable:
    * "traceability/require-branch-annotation": "error".
  - Satisfies DoD item: rule integrated into plugin configuration presets.

Tests tied to this story:
- tests/rules/require-branch-annotation.test.ts
  - Header:
    /** Tests for: docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md @story docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md @req REQ-BRANCH-DETECTION **/
  - Uses ESLint RuleTester.
  - valid cases cover:
    * Annotated IfStatement, ForStatement, While, DoWhile, ForOf, ForIn, SwitchCase, Try/Finally, Catch.
    * SwitchCase with comments and with default case.
    * Custom branchTypes configuration where unlisted types are ignored.
  - invalid cases cover:
    * Missing annotations on all significant branch types: if, for, while, do-while, for-of, for-in, switch-case, try/catch.
    * Each invalid scenario specifies expected output showing insertion of `// @story <story-file>.story.md` and/or `// @req <REQ-ID>` and corresponding errors with messageId "missingAnnotation" and data { missing: "@story" | "@req" }.
    * Specific invalid configuration case:
      - options: [{ branchTypes: ["UnknownType"] }].
      - Asserts an error with message matching /should be equal to one of the allowed values/.

- tests/utils/branch-annotation-helpers.test.ts
  - Header references this story and REQ-CONFIGURABLE-SCOPE.
  - Tests validateBranchTypes:
    * Returns DEFAULT_BRANCH_TYPES when no options.
    * Returns custom ["IfStatement", "ForStatement"] when valid options provided.
    * For invalid branchTypes ["UnknownType", "Foo"]:
      - validateBranchTypes returns listener with Program.
      - Program(fakeNode) triggers context.report for each invalid type with correct message fragment.

Documentation:
- docs/rules/require-branch-annotation.md
  - References this story and requirements:
    * @story docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md
    * @req REQ-BRANCH-DETECTION, REQ-CONFIGURABLE-SCOPE
  - Describes:
    * "Ensures that significant code branches (if/else, switch cases, loops, try/catch) have `@story` and `@req` annotations..."
    * Option branchTypes with default and allowed values matching DEFAULT_BRANCH_TYPES.
    * Behavior for invalid configuration with example and error message.
  - Provides correct/incorrect code examples and invalid-config example.

Test execution evidence:
- Command run: npm test -- --runInBand --verbose
  - Underlying: jest --ci --bail --runInBand --verbose
  - Output shows rule activity (console.debug) and no error or failure summary; the command succeeded, confirming all Jest tests (including the branch-annotation rule and helper tests) pass.</evidence>
  <notes>The `require-branch-annotation` ESLint rule is implemented, integrated, tested, and documented in alignment with docs/stories/004.0-DEV-BRANCH-ANNOTATIONS.story.md. It detects missing @story and @req annotations on significant branch types (if/else, loops, switch cases, try/catch), associates comments with branches (with special handling for SwitchCase), parses annotations, supports configurable branchTypes with robust validation and clear configuration errors, and provides auto-fixers with clear, user-facing messages. The rule is enabled in the plugin’s recommended and strict configs. Dedicated tests for the rule and its helpers pass under the project’s `npm test` command, and documentation under docs/rules/require-branch-annotation.md provides configuration and usage examples. All acceptance criteria and listed requirements for this story are satisfied.</notes>
</traceability>