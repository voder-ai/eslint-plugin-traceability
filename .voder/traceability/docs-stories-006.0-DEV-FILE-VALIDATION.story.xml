<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/006.0-DEV-FILE-VALIDATION.story.md</specification>
  <status>FAILED</status>
  <last_validated>2025-11-20T20:59:10.883Z</last_validated>
  <last_modified>2025-11-19T04:17:32.797Z</last_modified>
  <evidence>Story file exists: docs/stories/006.0-DEV-FILE-VALIDATION.story.md,Rule implementation: src/rules/valid-story-reference.ts,Supporting utilities: src/utils/storyReferenceUtils.ts,Rule documentation: docs/rules/valid-story-reference.md,Targeted tests: tests/rules/valid-story-reference.test.ts,Global tests executed successfully: `npm test -- --ci --no-watch --runInBand --verbose` (no non-zero exit reported),Targeted rule test invoked: `npx jest tests/rules/valid-story-reference.test.ts --ci --runInBand --verbose` (no non-zero exit reported),Rule meta & messages in src/rules/valid-story-reference.ts:
  - messages: { fileMissing, invalidExtension, invalidPath }
  - schema options: storyDirectories, allowAbsolutePaths, requireStoryExtension,Core validation logic in src/rules/valid-story-reference.ts:
  - Absolute path rejection when allowAbsolutePaths is false
  - Path traversal detection via containsPathTraversal + project-root (cwd) boundary check
  - Extension enforcement via hasValidExtension when requireStoryExtension is true
  - Existence check via normalizeStoryPath(...).exists with error messageId 'fileMissing',Path resolution & caching in src/utils/storyReferenceUtils.ts:
  - buildStoryCandidates(storyPath, cwd, storyDirs) builds candidate absolute paths
  - storyExists uses fs.existsSync + fs.statSync with Map-based cache (fileExistCache) for performance
  - normalizeStoryPath ties candidates + existence
  - containsPathTraversal, hasValidExtension and related helpers implement security and extension checks,Tests in tests/rules/valid-story-reference.test.ts cover:
  - Valid cases: existing .story.md paths, correct extension, relative ./ paths
  - Invalid cases: missing file => messageId 'fileMissing'; wrong extension => 'invalidExtension'; path traversal '../outside.story.md' => 'invalidPath'; absolute '/etc/passwd.story.md' => 'invalidPath',Documentation in docs/rules/valid-story-reference.md explicitly ties to this story and requirements:
  - Describes prevention of absolute paths and path traversal
  - Describes enforcing .story.md extension
  - Explains options: storyDirectories, allowAbsolutePaths, requireStoryExtension
  - Provides correct/incorrect examples consistent with the story</evidence>
  <notes>The majority of the story's requirements are implemented, but the 'Error Handling' acceptance criterion is not fully satisfied.

What is implemented and verified:
- **Core Functionality (REQ-FILE-EXISTENCE, REQ-PATH-RESOLUTION, REQ-SECURITY-VALIDATION, REQ-PERFORMANCE-OPTIMIZATION, REQ-CONFIGURABLE-PATHS)**
  - The `traceability/valid-story-reference` rule (src/rules/valid-story-reference.ts) inspects all comments for `@story` lines, extracts the path, and validates it.
  - It rejects **absolute paths** when `allowAbsolutePaths` is false and reports `invalidPath`.
  - It detects **path traversal** using `containsPathTraversal` and ensures resolved paths stay within `cwd` (project root); if they escape, it reports `invalidPath`.
  - It enforces the `.story.md` extension via `hasValidExtension` when `requireStoryExtension` is true, reporting `invalidExtension` when mismatched.
  - It checks **file existence** by delegating to `normalizeStoryPath` in `src/utils/storyReferenceUtils.ts`, which:
    - Builds candidate paths from `cwd`, `storyPath`, and configured `storyDirs`.
    - Uses `fs.existsSync` and `fs.statSync` plus a `Map` cache (`fileExistCache`) to avoid repeated filesystem hits (performance optimization).
  - Configuration options in rule meta schema and `create` support **configurable story directories and behavior** (`storyDirectories`, `allowAbsolutePaths`, `requireStoryExtension`), matching REQ-CONFIGURABLE-PATHS.
  - The rule is wired into the plugin export in `src/index.ts` and included in both `recommended` and `strict` configs, satisfying integration with the overall plugin behavior.

- **Integration with prior stories (format validation / annotation detection)**
  - This rule operates purely on `@story` comment lines and assumes syntactically valid annotations. That is consistent with story 005.0 (annotation format validation) handling the format, and this rule focusing solely on file validity.

- **User Experience (clear error messages)**
  - The rule defines concise, targeted messages:
    - `fileMissing`: "Story file '{{path}}' not found".
    - `invalidExtension`: "Invalid story file extension for '{{path}}', expected '.story.md'".
    - `invalidPath`: "Invalid story path '{{path}}'".
  - Tests assert the correct `messageId` and `data.path` for each scenario, so users get precise feedback about what is wrong with each `@story` reference.

- **Documentation**
  - `docs/rules/valid-story-reference.md` documents:
    - The rule’s purpose and its linkage to this story (via `@story` and `@req` tags).
    - Behavior for absolute paths, traversal, extension enforcement, and existence.
    - Configuration options and example correct/incorrect usages.
  - This matches the acceptance criterion for documentation including path resolution rules and examples.

Why the story is marked FAILED:
- The acceptance criteria include:
  - "**Error Handling**: Gracefully handles file system permissions, network drives, and edge cases."
- Current implementation does **not** include robust error handling around filesystem operations:
  - `storyExists` in `src/utils/storyReferenceUtils.ts` calls `fs.existsSync(candidate)` and then **unconditionally** calls `fs.statSync(candidate).isFile()` when `existsSync` returns true.
  - If the process lacks permissions to stat the file (e.g., EACCES on certain files, network drive issues, broken symlinks, transient I/O problems), `fs.statSync` will throw an exception.
  - Those exceptions are **not caught** anywhere in `storyExists`, `normalizeStoryPath`, `processStoryPath`, or the rule’s `create`/`Program` handlers.
  - As a result, in these edge cases the ESLint rule will throw and potentially break the lint run, which is **not** "graceful" handling as required by the story.
- There are **no tests** simulating or handling such permission or I/O error scenarios:
  - `tests/rules/valid-story-reference.test.ts` covers missing files, wrong extensions, traversal, and absolute paths, but does not cover permission-denied or filesystem error behavior.
  - Without try/catch and explicit reporting for these cases, the behavior is undefined and likely to throw.

Other minor gaps relative to the story text:
- **REQ-PROJECT-BOUNDARY** is partly addressed:
  - For traversal-style paths, the rule resolves the path and checks that it starts with `cwd + path.sep`, preventing traversal-based escapes from the project root.
  - However, there is no explicit validation that configured `storyDirectories` themselves remain inside the project boundary. Misconfigured options (e.g., `"../outside"`) could point outside the project without further checks.
  - The story’s requirement talks about "project boundaries" more generally than just traversal scenarios; in practice the current implementation covers the common traversal case but not misconfigured directories.

Given the explicit acceptance criterion around **graceful error handling of filesystem edge cases** and the absence of any guarding logic or tests for such errors, this story cannot be considered fully implemented yet and is therefore marked **FAILED**.</notes>
</traceability>