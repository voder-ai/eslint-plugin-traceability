<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/006.0-DEV-FILE-VALIDATION.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T08:32:09.735Z</last_validated>
  <last_modified>2025-11-20T23:56:53.139Z</last_modified>
  <evidence>Implementation:
- Rule file src/rules/valid-story-reference.ts:
  - JSDoc explicitly ties the rule to docs/stories/006.0-DEV-FILE-VALIDATION.story.md and requirements REQ-FILE-EXISTENCE, REQ-PATH-RESOLUTION, REQ-SECURITY-VALIDATION, REQ-ERROR-HANDLING, REQ-ANNOTATION-VALIDATION.
  - handleComment() inspects all comments from context.getSourceCode().getAllComments(), normalizes lines, and for each line starting with '@story' calls validateStoryPath(), satisfying REQ-ANNOTATION-VALIDATION.
  - validateStoryPath() extracts the story path token from the annotation line and delegates to processStoryPath().
  - processStoryPath() enforces:
    - Absolute path check using path.isAbsolute; if not allowed, reports messageId 'invalidPath'.
    - Path traversal check using containsPathTraversal() and a cwd-based boundary check; if resolved path escapes cwd, reports 'invalidPath' (REQ-SECURITY-VALIDATION, REQ-PROJECT-BOUNDARY).
    - Extension check using hasValidExtension(); if requireStoryExtension and extension is not .story.md, reports 'invalidExtension' (REQ-SECURITY-VALIDATION).
    - Then calls reportExistenceProblems() for existence and FS error handling.
  - reportExistenceProblems() uses normalizeStoryPath() and its 'existence' result:
    - If status === 'missing' reports 'fileMissing' with the path (REQ-FILE-EXISTENCE).
    - If status === 'fs-error' converts the error to a user-friendly string and reports 'fileAccessError' with { path, error } (REQ-ERROR-HANDLING and User Experience).
  - Rule meta:
    - messages: fileMissing, invalidExtension, invalidPath, fileAccessError with clear, focused error texts.
    - schema defines configurable options storyDirectories, allowAbsolutePaths, requireStoryExtension (REQ-CONFIGURABLE-PATHS).
  - create(context):
    - Uses process.cwd() as cwd and reads options[0] to configure storyDirectories, allowAbsolutePaths, requireStoryExtension; hooks Program() visitor to drive validation, integrating with existing annotation rules.

Utilities:
- src/utils/storyReferenceUtils.ts:
  - JSDoc ties utilities to Story 006 and requirements REQ-PATH-RESOLUTION, REQ-FILE-EXISTENCE, REQ-SECURITY-VALIDATION, REQ-ERROR-HANDLING, REQ-PERFORMANCE-OPTIMIZATION.
  - buildStoryCandidates(storyPath, cwd, storyDirs):
    - For './' or '../' paths, resolves relative to cwd.
    - Otherwise, considers both path.resolve(cwd, storyPath) and path.resolve(cwd, dir, basename(storyPath)) for each configured story directory (REQ-PATH-RESOLUTION, REQ-PROJECT-BOUNDARY).
  - fileExistStatusCache (Map<string, StoryPathCheckResult>) caches per-path existence checks (REQ-PERFORMANCE-OPTIMIZATION).
  - checkSingleCandidate():
    - Wraps fs.existsSync and fs.statSync in try/catch, never throws.
    - Returns status 'exists' for regular files, 'missing' if not present or not a file, 'fs-error' with captured error on any FS exception (REQ-FILE-EXISTENCE, REQ-ERROR-HANDLING).
  - getStoryExistence(candidates):
    - Returns first 'exists' result; otherwise first 'fs-error' if any; else 'missing'.
  - storyExists(paths): boolean wrapper around getStoryExistence, preserving legacy API while using the richer status (REQ-PERFORMANCE-OPTIMIZATION, REQ-ERROR-HANDLING).
  - normalizeStoryPath(storyPath, cwd, storyDirs): returns candidates, exists (boolean), and full existence result used by the rule.
  - Security helpers:
    - isAbsolutePath(), containsPathTraversal(), isTraversalUnsafe(), hasValidExtension(), isUnsafeStoryPath() implement absolute-path, traversal, and extension policies (REQ-SECURITY-VALIDATION).

Integration:
- src/index.ts:
  - RULE_NAMES includes 'valid-story-reference'.
  - Dynamic loader requires './rules/valid-story-reference' and assigns to rules.
  - configs.recommended and configs.strict both enable 'traceability/valid-story-reference': 'error'.
  - Confirms rule is part of the pluginâ€™s recommended configuration and integrated with other traceability rules.

Documentation:
- docs/rules/valid-story-reference.md:
  - Describes behavior: validates that @story references refer to existing .story.md files and prevents invalid path usage.
  - Annotated with @story docs/stories/006.0-DEV-FILE-VALIDATION.story.md and @req REQ-FILE-EXISTENCE, REQ-PATH-RESOLUTION, REQ-SECURITY-VALIDATION.
  - Lists behaviors matching the story: prevents absolute paths (unless allowed), prevents traversal outside project dir, ensures .story.md extension, resolves candidate file locations via configured storyDirectories, and reports fileMissing/invalidExtension/invalidPath.
  - Documents options (storyDirectories, allowAbsolutePaths, requireStoryExtension) and shows correct/incorrect examples, including missing files and wrong extensions (Documentation acceptance criterion).
- README.md:
  - Mentions 'traceability/valid-story-reference' with a link to docs/rules/valid-story-reference.md, exposing this feature in user-facing documentation.

Tests:
- tests/rules/valid-story-reference.test.ts:
  - File header:
    - 'Tests for: docs/stories/006.0-DEV-FILE-VALIDATION.story.md'
    - @story docs/stories/006.0-DEV-FILE-VALIDATION.story.md
    - @req REQ-FILE-EXISTENCE - Verify valid-story-reference rule enforces existing .story.md files.
  - RuleTester suite 'Valid Story Reference Rule (Story 006.0-DEV-FILE-VALIDATION)':
    - valid cases:
      - @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md.
      - @story docs/stories/002.0-DEV-ESLINT-CONFIG.story.md.
      - @story ./docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md.
      - These rely on actual story files in docs/stories (e.g., 001.0-DEV-PLUGIN-SETUP.story.md verified present by file search), confirming positive behavior.
    - invalid cases:
      - Missing file: expects 'fileMissing' for docs/stories/missing-file.story.md.
      - Wrong extension: expects 'invalidExtension' for docs/stories/001.0-DEV-PLUGIN-SETUP.md.
      - Path traversal: expects 'invalidPath' for '../outside.story.md'.
      - Absolute path: expects 'invalidPath' for '/etc/passwd.story.md'.
  - Additional error-handling tests 'Valid Story Reference Rule Error Handling (Story 006.0-DEV-FILE-VALIDATION)':
    - Mock fs.existsSync/statSync throwing EACCES and EIO errors; verify:
      - storyExists([...]) never throws and returns false in error scenarios.
      - The rule emits diagnostics with messageId 'fileAccessError' when FS errors occur and existsSync indicates presence, and that the diagnostic data.error text contains the underlying error codes (EIO, EACCES).
    - These tests directly target REQ-ERROR-HANDLING (permissions, IO errors, robust diagnostics).

Test run:
- npm test -- --runInBand --verbose
- npm test -- --runInBand --verbose --testLocationInResults
- Jest completed successfully with no reported test failures, confirming that tests for valid-story-reference (and therefore Story 006) are passing.</evidence>
  <notes>The 'valid-story-reference' rule and its supporting utilities fully implement Story 006.0-DEV-FILE-VALIDATION. The rule parses @story annotations, resolves paths relative to project cwd and configurable story directories, enforces the .story.md extension, and validates file existence using cached filesystem checks. Security requirements are met via absolute-path and traversal detection and by ensuring paths cannot escape the project boundary. Filesystem errors (permissions, IO, network issues) are handled gracefully, never causing rule crashes, and are surfaced as dedicated 'fileAccessError' diagnostics with clear messages. Configuration options allow customizing story directories and path policies. Comprehensive Jest tests cover core functionality, path resolution, security checks, and error handling behavior, and these tests pass in the current test run. Documentation in docs/rules/valid-story-reference.md and README.md explains behavior, configuration, and examples, satisfying the documentation and user experience criteria. Therefore, all acceptance criteria and listed requirements for this story are met.</notes>
</traceability>