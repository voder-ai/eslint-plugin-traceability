<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/006.0-DEV-FILE-VALIDATION.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T05:06:42.058Z</last_validated>
  <last_modified>2025-11-20T23:56:53.139Z</last_modified>
  <evidence>Implementation:
- Rule file src/rules/valid-story-reference.ts implements the ESLint rule described by the story. It:
  - Scans all comments in Program() via context.getSourceCode().getAllComments() and handleComment(), looking for lines starting with '@story' (REQ-ANNOTATION-VALIDATION).
  - Extracts the path token from each @story line in validateStoryPath() and passes it to processStoryPath().
  - Enforces security and path rules in processStoryPath():
    * Rejects absolute paths when allowAbsolutePaths is false, reporting messageId 'invalidPath' (REQ-SECURITY-VALIDATION, REQ-PROJECT-BOUNDARY).
    * Uses containsPathTraversal() and path.resolve to detect traversal outside cwd and reports 'invalidPath' if full path does not start with cwd + path.sep (REQ-SECURITY-VALIDATION, REQ-PROJECT-BOUNDARY).
    * Enforces the '.story.md' extension when requireStoryExtension is true using hasValidExtension(), reporting 'invalidExtension' for mismatch (REQ-SECURITY-VALIDATION).
  - Delegates existence and error classification to normalizeStoryPath() and reportExistenceProblems():
    * For existenceResult.status === 'missing', reports messageId 'fileMissing' with the original story path (REQ-FILE-EXISTENCE).
    * For existenceResult.status === 'fs-error', converts the underlying error into a human-readable string and reports 'fileAccessError' with data { path, error } (REQ-ERROR-HANDLING, clear diagnostics).
  - Configurability and integration:
    * meta.schema defines an options object with properties: storyDirectories (array of strings), allowAbsolutePaths (boolean), requireStoryExtension (boolean), and additionalProperties: false (REQ-CONFIGURABLE-PATHS).
    * In create(), uses process.cwd() and reads context.options[0] to compute:
      - storyDirs = opts?.storyDirectories || ["docs/stories", "stories"] (default directories, configurable search paths).
      - allowAbsolute = opts?.allowAbsolutePaths || false.
      - requireExt = opts?.requireStoryExtension !== false.
    * Rule meta.docs.description: "Validate that @story annotations reference existing .story.md files" matches the story.
  - User-facing messages:
    * fileMissing: "Story file '{{path}}' not found" (clear indication of missing file).
    * invalidExtension: "Invalid story file extension for '{{path}}', expected '.story.md'".
    * invalidPath: "Invalid story path '{{path}}'" (for traversal/absolute issues).
    * fileAccessError: "Could not validate story file '{{path}}' due to a filesystem error: {{error}}. Please check file existence and permissions." (explicitly differentiates filesystem/access issues from missing files).
  - The file is annotated with @story docs/stories/006.0-DEV-FILE-VALIDATION.story.md and @req entries for REQ-FILE-EXISTENCE, REQ-PATH-RESOLUTION, REQ-SECURITY-VALIDATION, REQ-ERROR-HANDLING, and REQ-ANNOTATION-VALIDATION, directly tying it to this story.

Filesystem & path utilities:
- src/utils/storyReferenceUtils.ts provides the core I/O and path logic referenced by the story:
  - buildStoryCandidates(storyPath, cwd, storyDirs) constructs absolute candidate paths based on cwd and configured story directories, handling both './' or '../' prefixed paths and bare paths (REQ-PATH-RESOLUTION, REQ-CONFIGURABLE-PATHS).
  - Caching and performance:
    * fileExistStatusCache: Map<string, StoryPathCheckResult> caches per-path results (REQ-PERFORMANCE-OPTIMIZATION).
    * checkSingleCandidate(candidate) checks fs.existsSync and fs.statSync inside try/catch, classifying outcomes as 'exists', 'missing', or 'fs-error'; results are cached (REQ-FILE-EXISTENCE, REQ-ERROR-HANDLING, REQ-PERFORMANCE-OPTIMIZATION).
  - getStoryExistence(candidates) aggregates across candidates:
    * Returns status 'exists' with matchedPath when any candidate is a file.
    * If none exist but any produced an fs error, returns status 'fs-error' with the first error attached.
    * Otherwise returns status 'missing'.
    * This function never throws, satisfying graceful error handling requirements (REQ-ERROR-HANDLING).
  - storyExists(paths) adapts the richer status API to a simple boolean (for backward compatibility) while still leveraging safe error handling.
  - normalizeStoryPath(storyPath, cwd, storyDirs) returns {candidates, exists, existence} and is used directly by the rule to decide how to report issues (REQ-FILE-EXISTENCE, REQ-PATH-RESOLUTION, REQ-PERFORMANCE-OPTIMIZATION).
  - Security helpers:
    * isAbsolutePath(), containsPathTraversal(), isTraversalUnsafe(), hasValidExtension(), isUnsafeStoryPath() encapsulate path traversal, absolute path detection, and extension checking (REQ-SECURITY-VALIDATION).
  - This file is also annotated with @story docs/stories/006.0-DEV-FILE-VALIDATION.story.md and includes @req tags covering REQ-FILE-EXISTENCE, REQ-ERROR-HANDLING, REQ-PATH-RESOLUTION, REQ-SECURITY-VALIDATION, and REQ-PERFORMANCE-OPTIMIZATION.

Plugin integration:
- src/index.ts:
  - RULE_NAMES includes 'valid-story-reference'.
  - Dynamic loader requires './rules/valid-story-reference' and assigns it into the rules export.
  - Both configs.recommended and configs.strict include:
    * "traceability/valid-story-reference": "error".
  - This confirms the rule is part of the main plugin and used in presets, satisfying the "Integration" acceptance criterion.

Tests for this story/rule:
- tests/rules/valid-story-reference.test.ts:
  - File header and JSDoc:
    * "Tests for: docs/stories/006.0-DEV-FILE-VALIDATION.story.md".
    * `@story docs/stories/006.0-DEV-FILE-VALIDATION.story.md`.
    * `@req REQ-FILE-EXISTENCE - Verify valid-story-reference rule enforces existing .story.md files`.
  - RuleTester suite "Valid Story Reference Rule (Story 006.0-DEV-FILE-VALIDATION)":
    * valid cases (no reported errors):
      - [REQ-FILE-EXISTENCE] valid story file reference: `// @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md` (file verified to exist via find_files in docs/stories).
      - [REQ-EXTENSION] valid .story.md extension: `// @story docs/stories/002.0-DEV-ESLINT-CONFIG.story.md`.
      - [REQ-PATH-RESOLUTION] valid relative path with ./ prefix: `// @story ./docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md`.
    * invalid cases assert specific error messages and data:
      - [REQ-PATH-RESOLUTION] missing file: `// @story docs/stories/missing-file.story.md` → error { messageId: 'fileMissing', data: { path: 'docs/stories/missing-file.story.md' } }.
      - [REQ-EXTENSION] invalid extension: `// @story docs/stories/001.0-DEV-PLUGIN-SETUP.md` → error { messageId: 'invalidExtension', data: { path: 'docs/stories/001.0-DEV-PLUGIN-SETUP.md' } }.
      - [REQ-PATH-SECURITY] path traversal: `// @story ../outside.story.md` → error { messageId: 'invalidPath', data: { path: '../outside.story.md' } }.
      - [REQ-ABSOLUTE-PATH] absolute path not allowed: `// @story /etc/passwd.story.md` → error { messageId: 'invalidPath', data: { path: '/etc/passwd.story.md' } }.
    * These cover existence, extension, path resolution, and security behavior with clear, user-focused error messages.
  - Additional error-handling suite "Valid Story Reference Rule Error Handling (Story 006.0-DEV-FILE-VALIDATION)":
    * Mocks fs.existsSync and fs.statSync to throw NodeJS.ErrnoException for EACCES and EIO, and verifies:
      - storyExists([...]) never throws and returns false when fs APIs throw (graceful fs handling, REQ-ERROR-HANDLING).
      - When fs.existsSync returns true and fs.statSync throws, the rule reports at least one diagnostic with messageId 'fileAccessError'; diagnostic.data.error string contains 'EIO' (ensures filesystem issues are reported as fileAccessError, not fileMissing).
      - When both existsSync and statSync throw EACCES, rule again produces fileAccessError diagnostics with data.error containing 'EACCES'.
    * These tests directly satisfy the story's requirement to "Gracefully handle file system permissions, network drives, and edge cases" with clear diagnostics.
  - The helper runRuleOnCode() drives the rule directly on a comment-only code string and collects context.report calls, used to assert detailed error behavior.

Config tests:
- tests/config/eslint-config-validation.test.ts:
  - Imports validStoryReference from src/rules/valid-story-reference.
  - Asserts that meta.schema[0] contains properties storyDirectories, allowAbsolutePaths, requireStoryExtension.
  - Asserts additionalProperties === false.
  - This validates the configuration surface described in the story under REQ-CONFIGURABLE-PATHS and ensures correct integration with the configuration system.

Documentation:
- Story spec docs/stories/006.0-DEV-FILE-VALIDATION.story.md exists and matches the behavior implemented.
- Developer docs docs/rules/valid-story-reference.md:
  - State the rule purpose: validates @story references to existing .story.md files; prevents absolute paths and path traversal; ensures .story.md extension; resolves candidate locations via configured storyDirectories; reports fileMissing, invalidExtension, invalidPath.
  - Provide usage examples that align with rule behavior and tests.
- User-facing docs user-docs/api-reference.md, section traceability/valid-story-reference:
  - Document options storyDirectories, allowAbsolutePaths, requireStoryExtension with defaults ["docs/stories", "stories"], false, and true respectively.
  - Provide configuration example matching the story and rule meta.schema.

Tests & execution:
- The project test command is npm test (configured as jest --ci --bail). Running `npm test -- --verbose` completed successfully with no failing tests; this includes tests for valid-story-reference.
- A focused run `npm test -- --verbose --runTestsByPath tests/rules/valid-story-reference.test.ts` executed without reporting any test failures, confirming the behavior for this story is passing under Jest.

File existence checks for referenced stories:
- docs/stories/001.0-DEV-PLUGIN-SETUP.story.md, 002.0-DEV-ESLINT-CONFIG.story.md, and 003.0-DEV-FUNCTION-ANNOTATIONS.story.md all exist in docs/stories, making the 'valid' RuleTester cases realistic and demonstrating that the rule correctly identifies existing .story.md files.</evidence>
  <notes>The 006.0-DEV-FILE-VALIDATION story is fully implemented. The valid-story-reference ESLint rule, supported by storyReferenceUtils, validates that @story paths exist, have the correct .story.md extension, are resolved from the project root/configured directories, and do not escape project boundaries via absolute paths or traversal. Filesystem errors are caught and converted into a dedicated fileAccessError diagnostic rather than thrown, with clear, user-oriented error messages. Configuration is exposed and validated via rule meta.schema and tested to ensure only the expected options are allowed. Comprehensive tests cover positive and negative file existence scenarios, path and extension validation, and multiple filesystem error conditions, all passing in Jest test runs. Developer and user documentation accurately describe the rule’s behavior and configuration. All acceptance criteria and listed requirements for this story are therefore satisfied.</notes>
</traceability>