<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/007.0-DEV-ERROR-REPORTING.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T07:40:17.508Z</last_validated>
  <last_modified>2025-11-21T04:06:15.924Z</last_modified>
  <evidence>Key files and links to Story 007:
- Story file exists: docs/stories/007.0-DEV-ERROR-REPORTING.story.md
- Direct implementation reference:
  - src/utils/annotation-checker.ts
    - JSDoc includes: @story docs/stories/007.0-DEV-ERROR-REPORTING.story.md
    - Requirements: @req REQ-ERROR-SPECIFIC, @req REQ-ERROR-LOCATION
    - reportMissing(context, node):
      - Computes name via getNodeName(node) with fallback to "(anonymous)"
      - context.report({ node, messageId: "missingReq", data: { name }, fix: createMissingReqFix(node) })
      - Ensures missing-@req errors are specific (include function name) and always have location context.

Story-specific tests:
- tests/rules/error-reporting.test.ts
  - Header:
    - "Tests for: docs/stories/007.0-DEV-ERROR-REPORTING.story.md"
    - @story docs/stories/007.0-DEV-ERROR-REPORTING.story.md
    - @req REQ-ERROR-SPECIFIC, REQ-ERROR-SUGGESTION, REQ-ERROR-CONTEXT
  - Uses RuleTester with require-story-annotation rule.
  - Valid case: function with existing @story annotation → no errors.
  - Invalid case:
    - code: function bar() {}
    - output inserts a JSDoc @story.
    - errors[0]: { messageId: "missingStory", data: { name: "bar" }, suggestions: [ { desc: "Add JSDoc @story annotation for function 'bar', e.g., /** @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md */", output: "...fixed code..." } ] }
  - Confirms: specific error content, includes function name, and concrete suggestion text with example annotation per REQ-ERROR-SPECIFIC, REQ-ERROR-SUGGESTION, and REQ-ERROR-CONTEXT.

Enhanced require-req-annotation behavior:
- src/rules/require-req-annotation.ts
  - meta.messages.missingReq: "Missing @req annotation for function '{{name}}' (REQ-ANNOTATION-REQUIRED)"
  - Uses {{name}} placeholder → ESLint will show function name.
- src/utils/annotation-checker.ts
  - reportMissing(context, node) (tagged with Story 007 and REQ-ERROR-SPECIFIC / REQ-ERROR-LOCATION):
    - Derives readable name via getNodeName, fallback to "(anonymous)".
    - Calls context.report with messageId "missingReq" and data { name } and a fix function.
- tests/rules/require-req-annotation.test.ts
  - Header references Story 007 and REQ-ERROR-SPECIFIC.
  - Invalid cases assert errors like:
    - { messageId: "missingReq", data: { name: "baz" } }
  - Confirms specific, name-bearing error messages for missing @req.

Function-annotation error messages and suggestions:
- src/rules/require-story-annotation.ts
  - meta.messages.missingStory: "Missing @story annotation for function '{{name}}' (REQ-ANNOTATION-REQUIRED)"
  - meta.hasSuggestions: true
- src/rules/helpers/require-story-helpers.ts
  - reportMissing(...) and reportMethod(...):
    - Use extractName(...) with safe fallback to "(anonymous)".
    - context.report({ node: nameNode, messageId: "missingStory", data: { name }, fix: createAddStoryFix(...), suggest: [ { desc: `Add JSDoc @story annotation for function '${name}', e.g., ${ANNOTATION}`, fix: createAddStoryFix(...) } ] })
    - Wrapped in try/catch to avoid crashes on incomplete context.
- tests/rules/require-story-annotation.test.ts
  - Invalid examples assert both the messageId and detailed suggestion descriptions and outputs for various function forms.
  - Confirms clear, specific messages and ESLint suggestions for missing @story.

Branch-annotation messaging:
- src/rules/require-branch-annotation.ts
  - meta.messages.missingAnnotation: "Missing {{missing}} annotation on code branch"
    - {{missing}} set to "@story" or "@req".
- src/utils/branch-annotation-helpers.ts
  - reportMissingStory(...) and reportMissingReq(...):
    - context.report({ node, messageId: "missingAnnotation", data: { missing: "@story" | "@req" }, fix: ... (autofix) ... }) for first occurrence, else just report.
  - Tests: tests/rules/require-branch-annotation.test.ts assert:
    - errors like { messageId: "missingAnnotation", data: { missing: "@story" } } and corresponding fixed outputs.
  - Matches the story’s branch error pattern with a generic missingAnnotation message and a {{missing}} placeholder.

Annotation format / validation messages (context and specificity):
- src/rules/valid-annotation-format.ts
  - meta.messages:
    - invalidStoryFormat: "{{details}}"
    - invalidReqFormat: "{{details}}"
  - Helper functions:
    - buildStoryErrorMessage(kind, value) and buildReqErrorMessage(kind, value) create detailed English messages including expected formats and example values.
    - validateStoryAnnotation(...) / validateReqAnnotation(...) call context.report with messageId and data.details set to those messages.
  - Tests: tests/rules/valid-annotation-format.test.ts
    - Invalid cases assert exact strings in data.details, e.g.:
      - Missing story path → "Missing story path for @story annotation. Expected a path like \"docs/stories/005.0-DEV-EXAMPLE.story.md\"."
      - Invalid story path or req ID formats with full explanations.
    - Confirms highly specific, explanatory error content and consistent use of {{details}} (REQ-ERROR-SPECIFIC, REQ-ERROR-CONTEXT, REQ-ERROR-CONSISTENCY).

File and requirement reference messages and error handling:
- src/rules/valid-story-reference.ts
  - meta.messages:
    - fileMissing: "Story file '{{path}}' not found"
    - invalidExtension: "Invalid story file extension for '{{path}}', expected '.story.md'"
    - invalidPath: "Invalid story path '{{path}}'"
    - fileAccessError: "Could not validate story file '{{path}}' due to a filesystem error: {{error}}. Please check file existence and permissions."
  - processStoryPath(...) & reportExistenceProblems(...):
    - Distinguish missing files vs filesystem errors via normalizeStoryPath/existence.status.
    - Report with appropriate messageIds and {{path}} / {{error}} placeholders.
  - Tests: tests/rules/valid-story-reference.test.ts
    - Validate normal cases (missing files, bad extensions, traversal, absolute paths) and assert expected messageIds & data.path.
    - Additional error-handling tests use fs mocks to simulate EACCES/EIO and assert messageId "fileAccessError" and data.error including underlying error message.

- src/rules/valid-req-reference.ts
  - meta.messages:
    - reqMissing: "Requirement '{{reqId}}' not found in '{{storyPath}}'"
    - invalidPath: "Invalid story path '{{storyPath}}'"
  - validateReqLine(...) reports invalid paths and missing requirements with full reqId and storyPath in data.
  - Tests: tests/rules/valid-req-reference.test.ts assert these messages and data for missing req IDs and invalid paths.

Severity and ESLint integration:
- src/index.ts
  - In exported configs (recommended/strict):
    - require-story-annotation, require-req-annotation, require-branch-annotation: "error"
    - valid-story-reference, valid-req-reference: "error"
    - valid-annotation-format: "warn"
  - Matches story’s severity conventions: missing annotations/references → errors; format issues → warnings.

Graceful error handling / incomplete context:
- src/utils/annotation-checker.ts
  - reportMissing uses getNodeName with fallback to "(anonymous)", ensuring name presence even when AST is incomplete.
- src/rules/helpers/require-story-helpers.ts
  - hasStoryAnnotation, reportMissing, reportMethod wrap complex logic in try/catch to avoid throwing when sourceCode APIs or nodes are incomplete.
- src/rules/helpers/require-story-core.ts
  - reportMissing falls back to context.getSourceCode() when sourceCode is missing.
  - tests/rules/require-story-core-edgecases.test.ts asserts that when sourceCode is missing getJSDocComment, reportMissing still calls context.report once with messageId "missingStory".
  - These behaviors demonstrate REQ-ERROR-HANDLING and “graceful handling of edge cases where error context is incomplete.”

Documentation of error message formats:
- docs/stories/007.0-DEV-ERROR-REPORTING.story.md
  - Contains an explicit "Error Message Conventions" section documenting function, branch, format, and file/reference error patterns, and severity conventions.
  - The implemented messages and placeholders ({{name}}, {{missing}}, {{details}}, {{path}}, {{reqId}}, {{storyPath}}) align closely with this documentation.

Test execution:
- package.json: "test": "jest --ci --bail"
- Command run in this session: npm test -- --ci --bail --runInBand --verbose
  - Jest completed without reporting any failed tests.
  - This includes the story-specific tests (tests/rules/error-reporting.test.ts and the enhanced require-req-annotation tests) and all rule tests, confirming that the implemented error messaging and suggestions behave as expected.</evidence>
  <notes>Story 007.0-DEV-ERROR-REPORTING is fully implemented and validated.

All acceptance criteria are met:
- Core functionality: Every validation rule emits specific, actionable error messages instead of generic failures. Function rules include function names; branch rules identify which annotation is missing; format and reference rules provide detailed explanations and example formats.
- Quality standards & integration: All rules use ESLint’s messageId + data pattern and ESLint’s reporting API correctly. Tests exercise these behaviors via RuleTester and pass under Jest.
- User experience: Messages clearly identify the problem and location (via function name, story path, requirement ID) and, where appropriate, include explicit suggestions and example annotations. Auto-fix behavior is paired with textual guidance.
- Error handling: Helper functions and rules are defensive (try/catch, fallbacks, differentiation between missing files and filesystem errors). Dedicated tests verify behavior under incomplete context and filesystem errors.
- Documentation: The story itself documents cross-rule error message conventions and severity, and the implementation closely follows these conventions. Additional development docs reinforce correct use of context.report and message IDs.

Given the direct code references to this story, comprehensive tests specifically tagged to docs/stories/007.0-DEV-ERROR-REPORTING.story.md, and a successful Jest run, the implementation satisfies all requirements for this story.</notes>
</traceability>