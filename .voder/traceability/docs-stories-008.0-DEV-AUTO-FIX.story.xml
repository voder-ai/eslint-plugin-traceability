<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/008.0-DEV-AUTO-FIX.story.md</specification>
  <status>FAILED</status>
  <last_validated>2025-11-21T05:06:36.870Z</last_validated>
  <last_modified>2025-11-19T04:17:32.825Z</last_modified>
  <evidence>Key findings from repository inspection and tests:

1. Story presence and references
- Story file exists: docs/stories/008.0-DEV-AUTO-FIX.story.md
- grep -R 008.0-DEV-AUTO-FIX docs src tests
  - Only references are in:
    - docs/stories/008.0-DEV-AUTO-FIX.story.md
    - docs/stories/developer-story.map.md
  - No source files or tests reference this story path or its requirement IDs (REQ-AUTOFIX-MISSING, REQ-AUTOFIX-FORMAT, etc.).

2. Existing auto-fix implementations (but traced to earlier stories, not 008.0)

2.1 Function @story autofix helpers
- File: src/rules/helpers/require-story-core.ts
  - createAddStoryFix(target: any):
    - Inserts a @story annotation before a target node:
      ```ts
      return fixer.insertTextBeforeRange([start, start], `${ANNOTATION}\n`);
      ```
    - JSDoc:
      ```ts
      /**
       * Create a fixer function that inserts a @story annotation before the target node.
       * @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md
       * @req REQ-AUTOFIX - Provide automatic fix function for missing @story annotations
       */
      ```
  - createMethodFix(node: any): similar for methods, inserts:
    ```ts
    return fixer.insertTextBeforeRange([start, start], `${ANNOTATION}\n  `);
    ```
  - reportMissing(...) and reportMethod(...) use these fixers via suggestions, not direct fixes:
    ```ts
    context.report({
      node: nameNode,
      messageId: "missingStory",
      data: { name },
      suggest: [
        {
          desc: `Add JSDoc @story annotation for function '${name}', e.g., ${ANNOTATION}`,
          fix: createAddStoryFix(resolvedTarget),
        },
      ],
    });
    ```
- File: src/rules/helpers/require-story-helpers.ts
  - Defines:
    ```ts
    const STORY_PATH = "docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md";
    const ANNOTATION = `/** @story ${STORY_PATH} */`;
    ```
  - reportMissing/reportMethod delegate to the autofix helpers and expose suggestions only (no top-level `fix`):
    ```ts
    context.report({
      node: nameNode,
      messageId: "missingStory",
      data: { name },
      suggest: [ { desc: ..., fix: createAddStoryFix(resolvedTarget) } ],
    });
    ```
- File: src/rules/require-story-annotation.ts
  - meta has `hasSuggestions: true` but **no** `fixable` and no `fix` functions; fixes are only exposed as suggestions:
    ```ts
    meta: {
      type: "problem",
      docs: { ... },
      hasSuggestions: true,
      messages: { missingStory: "Missing @story ..." },
      schema: [...],
    }
    ```
  - This means `eslint --fix` will NOT automatically apply these suggestion-based fixes.

2.2 Branch annotation autofix (code branches)
- File: src/rules/require-branch-annotation.ts
  - meta includes `fixable: "code"`:
    ```ts
    meta: {
      type: "problem",
      docs: { ... },
      fixable: "code",
      messages: { missingAnnotation: "Missing {{missing}} annotation on code branch" },
      schema: [...],
    }
    ```
- File: src/utils/branch-annotation-helpers.ts
  - reportMissingStory(...) defines a real fixer for missing @story on branches:
    ```ts
    function insertStoryFixer(fixer: any) {
      return fixer.insertTextBeforeRange(
        [insertPos, insertPos],
        `${indent}// @story <story-file>.story.md\n`,
      );
    }

    context.report({
      node,
      messageId: "missingAnnotation",
      data: { missing: "@story" },
      fix: insertStoryFixer,
    });
    ```
  - reportMissingReq(...) defines a fixer for missing @req on branches:
    ```ts
    function insertReqFixer(fixer: any) {
      return fixer.insertTextBeforeRange(
        [insertPos, insertPos],
        `${indent}// @req <REQ-ID>\n`,
      );
    }

    context.report({
      node,
      messageId: "missingAnnotation",
      data: { missing: "@req" },
      fix: insertReqFixer,
    });
    ```
  - These are true ESLint fixes that `eslint --fix` will apply.

2.3 @req autofix on functions
- File: src/utils/annotation-checker.ts
  - createMissingReqFix(node):
    ```ts
    function createMissingReqFix(node: any) {
      return function missingReqFix(fixer: any) {
        return fixer.insertTextBefore(node, "/** @req <REQ-ID> */\n");
      };
    }
    ```
  - reportMissing(...) uses `fix: createMissingReqFix(node)` in context.report.
- File: src/rules/require-req-annotation.ts
  - meta.fixable: "code" is set.
  - These together mean `eslint --fix` will automatically insert placeholder `@req` annotations for missing cases.

3. Tests for existing autofix behavior (but tied to earlier stories)

3.1 Function @story autofix helpers
- File: tests/rules/require-story-core.test.ts
  - Verifies createMethodFix and reportMethod behavior, including the fixer inserting ANNOTATION with preserved indentation.
- File: tests/rules/require-story-core.autofix.test.ts and tests/rules/require-story-core-edgecases.test.ts
  - Exercise createAddStoryFix and reportMissing logic, including fallbacks for null/edge ranges.
  - All tests annotate with:
    ```ts
    * Tests for: docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md
    * @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md
    * @req REQ-AUTOFIX - ...
    ```
  - No references to docs/stories/008.0-DEV-AUTO-FIX.story.md or its requirement IDs.

3.2 Branch autofix tests
- File: tests/rules/require-branch-annotation.test.ts
  - Invalid cases specify `output` fields, proving RuleTester recognizes automatic fixes:
    Example:
    ```ts
    {
      name: "[REQ-BRANCH-DETECTION] missing annotations on if-statement",
      code: `if (condition) {}`,
      output: `// @story <story-file>.story.md\nif (condition) {}`,
      errors: [
        { messageId: "missingAnnotation", data: { missing: "@story" } },
        { messageId: "missingAnnotation", data: { missing: "@req" } },
      ],
    }
    ```

3.3 @req autofix tests
- File: tests/utils/annotation-checker.test.ts
  - Uses RuleTester with invalid cases specifying `output` showing added `@req` comments.

3.4 require-story-annotation tests DO NOT use `output`
- File: tests/rules/require-story-annotation.test.ts
  - Invalid cases for missing @story on functions specify `errors` and `suggestions` (expected suggestion descriptions and outputs), **not** the `output` property used for automatic fixes.
  - This matches the implementation using `suggest` rather than `fix`, i.e., the rule does not auto-fix on `--fix`.

4. Tests executed
- Command run: `npm test -- --verbose`
- Output (truncated here) shows Jest starting and debug logging from require-story-annotation visitors, with no reported failures or errors; Jest exits successfully (npm command did not error), indicating all existing tests pass. However, no tests are tagged against `docs/stories/008.0-DEV-AUTO-FIX.story.md` or its REQ-* IDs.

5. Evaluation against 008.0 story acceptance criteria and requirements

5.1 Core Functionality: "ESLint --fix automatically resolves common annotation violations"
- Implemented:
  - `traceability/require-req-annotation` auto-fixes missing `@req` on applicable nodes via `fix` and meta.fixable="code".
  - `traceability/require-branch-annotation` auto-fixes missing `@story` and `@req` on branches (first missing @story and certain @req cases) via `fix` and meta.fixable="code".
- NOT implemented for the most central case described by this story:
  - Missing `@story` annotations on functions are only handled via **suggestions** in `require-story-annotation` (meta.hasSuggestions = true, no meta.fixable, and context.report uses `suggest: [...]` not `fix`).
  - ESLint's `--fix` does **not** apply suggestions; it only applies fixes provided via `fix` callbacks and when meta.fixable is set.
- Therefore REQ-AUTOFIX-MISSING ("Automatically add missing @story annotations to functions using template format") is **not satisfied**.

5.2 REQ-AUTOFIX-FORMAT: "Fix common annotation format issues (spacing, syntax, casing)"
- File: src/rules/valid-annotation-format.ts
  - Only validates and reports invalid formats using `context.report` with `messageId: "invalidStoryFormat"` or `"invalidReqFormat"`.
  - No `fix` functions are provided anywhere in this rule; meta has **no** `fixable` property.
- Conclusion: the plugin detects but does **not** auto-fix format issues; this requirement is **not met**.

5.3 REQ-AUTOFIX-SAFE and REQ-AUTOFIX-PRESERVE: safety and formatting preservation
- Existing fixers are relatively conservative (they insert comments immediately above nodes, respecting indentation for branch fixes and method fixes), and tests assert exact output, which incidentally preserves code structure.
- However, since key functional requirements (e.g., REQ-AUTOFIX-MISSING for functions, REQ-AUTOFIX-FORMAT) are not met, these criteria cannot be considered fully satisfied for the scope of this story.

5.4 REQ-AUTOFIX-TEMPLATE: "Use configurable annotation templates for consistent formatting"
- There is no configuration option anywhere allowing users to customize annotation templates for the fixes:
  - Function story fixes always use a hard-coded `ANNOTATION` constant bound to `docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md`.
  - Branch fixes always insert:
    - `// @story <story-file>.story.md` and `// @req <REQ-ID>`.
  - @req fixes always insert `/** @req <REQ-ID> */\n`.
- No rule schemas or plugin-level configs expose toggles or templates for these values.
- Thus REQ-AUTOFIX-TEMPLATE is **not implemented**.

5.5 REQ-AUTOFIX-SELECTIVE: "Allow developers to choose which types of fixes to enable/disable"
- Examination of rule schemas:
  - require-story-annotation: options are `scope` and `exportPriority` only.
  - require-req-annotation: schema is `[]` (no options).
  - require-branch-annotation: only `branchTypes` configuration; nothing about enabling/disabling fixes.
- There is no configuration mechanism exposed to selectively enable or disable specific auto-fix behaviors.
- Therefore REQ-AUTOFIX-SELECTIVE is **not satisfied**.

5.6 Integration, User Experience, Error Handling
- Integration with ESLint is partially demonstrated (tests for autofixes via RuleTester and some CLI integration tests for core validation), but there are:
  - No tests or docs showing end-to-end behavior of `eslint --fix` for annotation issues as described in this specific story.
  - No tests referenced to docs/stories/008.0-DEV-AUTO-FIX.story.md.
- Error handling for unfixable annotation issues (e.g., when auto-fix cannot be safely applied) is not clearly separated or documented as part of this story; existing logic is focused on deciding whether to emit a fix or just a report for branches, not a generalized strategy for all annotation issues.

5.7 Documentation criterion
- README.md and docs/rules/*.md:
  - They document rules and their validation behavior but do **not** document the auto-fix capabilities described in the 008.0 story (no dedicated section that explains which annotation violations can be auto-fixed, templates used, or how `--fix` behaves per rule).
- There is no story-specific developer or user documentation tied to 008.0 beyond the story file itself.
- Thus the "Documentation" acceptance criterion is **not met**.

6. Traceability alignment
- grep -R REQ-AUTOFIX src tests docs/stories:
  - REQ-AUTOFIX appears in src/rules/helpers/require-story-core.ts and several tests, but:
    - Story 008.0 defines different requirement IDs (REQ-AUTOFIX-MISSING, REQ-AUTOFIX-FORMAT, etc.).
    - All REQ-AUTOFIX references are tagged to docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md in code and tests, not to 008.0.
- No code or tests carry `@story docs/stories/008.0-DEV-AUTO-FIX.story.md` annotations, so there is no direct traceability from this story to the implementation, which further indicates this story has not been explicitly implemented.
</evidence>
  <notes>The specification in docs/stories/008.0-DEV-AUTO-FIX.story.md is not fully implemented.

While the project already contains several auto-fix mechanisms (for missing @req on functions and missing @story/@req on branches), these are all attributed to earlier stories (003.0 and 004.0) and are implemented either as suggestions (for function @story annotations) or as hard-coded fixes without configurability. There is no code or tests explicitly tied to the 008.0 story or to its requirement IDs.

Critically:
- Missing @story annotations on functions (the core use case) are only offered as suggestions, not as automatic fixes, so `eslint --fix` does not resolve them. This directly violates REQ-AUTOFIX-MISSING and the core functionality acceptance criterion.
- There is no auto-fix for annotation format issues (REQ-AUTOFIX-FORMAT).
- Annotation templates used by fixes are hard-coded and not configurable (REQ-AUTOFIX-TEMPLATE not met).
- There is no configuration to selectively enable/disable different categories of fixes (REQ-AUTOFIX-SELECTIVE not met).
- Documentation does not describe the auto-fix behavior in the way the story requires, and no tests are tagged to this story.

Therefore, despite some pre-existing autofix behavior related to other stories, the specific requirements and acceptance criteria of 008.0-DEV-AUTO-FIX are not satisfied. Status: FAILED.</notes>
</traceability>