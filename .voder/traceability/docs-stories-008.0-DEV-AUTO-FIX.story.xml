<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/008.0-DEV-AUTO-FIX.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T07:31:13.621Z</last_validated>
  <last_modified>2025-11-21T07:04:44.915Z</last_modified>
  <evidence>Story file and linkage:
- Story file docs/stories/008.0-DEV-AUTO-FIX.story.md exists and matches the provided specification.
- Implementation files reference this story via @story tags:
  - src/rules/require-story-annotation.ts
  - src/rules/valid-annotation-format.ts
  - src/rules/helpers/require-story-helpers.ts
  - src/rules/helpers/require-story-core.ts

Dedicated tests for this story:
- tests/rules/auto-fix-behavior-008.test.ts
  - File header:
    - `@story docs/stories/008.0-DEV-AUTO-FIX.story.md`
    - `@req REQ-AUTOFIX-MISSING` and `@req REQ-AUTOFIX-FORMAT`.
  - For REQ-AUTOFIX-MISSING (require-story-annotation):
    - Valid cases confirm that already annotated functions/methods are left unchanged.
    - Invalid cases verify both reporting and exact auto-fix output for:
      - Plain function declaration:
        - Input: `function autoFixMe() {}`
        - Output: `/** @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md */\nfunction autoFixMe() {}`
      - Function expression assigned to const.
      - Class method.
      - TS declare function.
      - TS interface method signature.
    - Each invalid case specifies `messageId: "missingStory"` and an ESLint suggestion with the exact expected `output`, verifying ESLint --fix / suggestion-based fixes.
  - For REQ-AUTOFIX-FORMAT (valid-annotation-format):
    - Valid case: correctly suffixed path `// @story docs/stories/005.0-DEV-EXAMPLE.story.md` is unchanged.
    - Invalid cases with expected fixed output:
      - `.story` → `.story.md`:
        - Input: `// @story docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story`
        - Output: `// @story docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story.md`
      - Bare path (no extension) → `.story.md`:
        - Input: `// @story docs/stories/005.0-DEV-ANNOTATION-VALIDATION`
        - Output: `// @story docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story.md`

Implementation of missing-annotation auto-fix (REQ-AUTOFIX-MISSING, REQ-AUTOFIX-SAFE, REQ-AUTOFIX-PRESERVE):
- src/rules/require-story-annotation.ts
  - Meta configuration:
    - `fixable: "code"` (enables ESLint --fix).
    - `hasSuggestions: true`.
    - Description: "Require @story annotations on functions and auto-fix missing annotations where possible".
    - Annotated with `@story docs/stories/008.0-DEV-AUTO-FIX.story.md` and requirements:
      - `@req REQ-AUTOFIX-MISSING`
      - `@req REQ-AUTOFIX-SAFE`
      - `@req REQ-AUTOFIX-PRESERVE`.
  - `create(context)` obtains `sourceCode`, reads options, logs debug info, and delegates to `buildVisitors(context, sourceCode, { shouldProcessNode, scope, exportPriority })` from require-story-visitors, integrating auto-fix helpers.
- src/rules/helpers/require-story-helpers.ts
  - Defines the built-in annotation template and story path:
    - `const STORY_PATH = "docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md";`
    - `const ANNOTATION = `/** @story ${STORY_PATH} */`;`.
  - `hasStoryAnnotation(...)` consolidates multiple heuristics (JSDoc, commentsBefore, leadingComments, nearby lines, parent chain, fallback text) to detect an existing @story and avoid duplicate annotations, preserving existing formatting and annotations.
  - `resolveTargetNode(...)` determines where to insert annotations, correctly handling:
    - TSMethodSignature (returns the interface node).
    - Function expressions/arrow functions in variable declarators, export declarations, expression statements.
  - `reportMissing(context, sourceCode, node, passedTarget?)`:
    - Uses `extractName` to get a human-readable function name.
    - Calls `hasStoryAnnotation`; if true, returns without reporting.
    - Resolves the insertion target via `resolveTargetNode` when not provided.
    - Chooses an appropriate `nameNode` for highlighting.
    - Calls `context.report` with:
      - `messageId: "missingStory"`.
      - `data: { name }`.
      - `fix: createAddStoryFix(resolvedTarget)`.
      - `suggest` array with the same fix and a descriptive message referencing the exact placeholder `ANNOTATION`.
    - Wrapped in try/catch to avoid crashing on unexpected AST shapes, gracefully handling edge cases.
    - Annotated with:
      - `@story docs/stories/008.0-DEV-AUTO-FIX.story.md`
      - `@req REQ-AUTOFIX-MISSING`.
  - `reportMethod(...)` behaves similarly for method-like nodes, using `createMethodFix` and also guarded by `hasStoryAnnotation`.
- src/rules/helpers/require-story-core.ts
  - `createAddStoryFix(target)`:
    - Computes a safe insertion `start` position, preferring parent export declarations when present.
    - Returns a fixer that performs `fixer.insertTextBeforeRange([start, start], `${ANNOTATION}\n`)`.
    - This inserts only the single-line JSDoc placeholder and a newline, without touching function bodies or other comments.
  - `createMethodFix(node)`:
    - Similar but inserts `ANNOTATION` followed by `\n  ` to maintain indentation for methods.
  - These fixers only add comments; they never modify runtime code, satisfying safety and non-destructiveness.
- src/rules/helpers/require-story-visitors.ts
  - Builds specific visitors for all relevant function-like node types (FunctionDeclaration, FunctionExpression, ArrowFunctionExpression, TSDeclareFunction, TSMethodSignature, MethodDefinition).
  - Each visitor checks `options.shouldProcessNode(node)` and then delegates to `helperReportMissing` or `helperReportMethod`, wiring auto-fix capability into the rule.
  - Debug logging demonstrates that the rule is invoked in tests (as shown in Jest console output).

Implementation of annotation-format auto-fix (REQ-AUTOFIX-FORMAT, REQ-AUTOFIX-SAFE, REQ-AUTOFIX-PRESERVE):
- src/rules/valid-annotation-format.ts
  - Rule meta:
    - `fixable: "code"`.
    - JSDoc explicitly states:
      - Auto-fix behavior is limited to safe `@story` path suffix normalization (adding `.md` or `.story.md`).
      - It never changes directories or infers new story names.
    - Tagged with `@story docs/stories/008.0-DEV-AUTO-FIX.story.md` and requirements including `@req REQ-AUTOFIX-FORMAT`, `@req REQ-AUTOFIX-SAFE`, `@req REQ-AUTOFIX-PRESERVE`.
  - `getFixedStoryPath(original: string): string | null`:
    - Returns `null` (no fix) when:
      - `original.includes("..")` (skips paths with traversal segments).
      - Path already ends with `.story.md`.
    - Handles only these safe transformations:
      - `*.story` → `*.story.md`.
      - `*.md` (but not `*.story.md`) → normalized to `*.story.md`.
      - No extension → append `.story.md`.
    - This aligns with REQ-AUTOFIX-FORMAT and REQ-AUTOFIX-SAFE.
  - `reportInvalidStoryFormat(context, comment, collapsed)`:
    - Reports `invalidStoryFormat` with a detailed message from `buildStoryErrorMessage`, but no fix.
  - `reportInvalidStoryFormatWithFix(context, comment, collapsed, fixed)`:
    - Obtains full comment text from `context.getSourceCode().getText(comment)`.
    - Finds the `@story` tag index, and if missing, falls back to `reportInvalidStoryFormat`.
    - Uses a regex to extract the exact value substring after `@story`, computing precise start/end indices for that value inside the comment.
    - Calls `context.report` with `messageId: "invalidStoryFormat"` and `fix(fixer) { return fixer.replaceTextRange(fixRange, fixed); }`.
    - Only replaces the path substring, leaving all other comment text, whitespace, and structure unchanged.
    - If the tag or value cannot be found reliably, it falls back to no-fix reporting, gracefully handling ambiguous or malformed comments.
  - `validateStoryAnnotation(context, comment, rawValue)`:
    - Trims and validates the @story value.
    - Defines a strict pattern: `^docs\/stories\/[0-9]+\.[0-9]+-DEV-[\w-]+\.story\.md$`.
    - If pattern matches → no report or fix.
    - If whitespace is present in the trimmed value → reports invalid format without fix (avoids risky transformations), satisfying REQ-AUTOFIX-SAFE.
    - Otherwise, calls `getFixedStoryPath`:
      - If a fixed value exists and matches the strict pattern, calls `reportInvalidStoryFormatWithFix` to apply the suffix-only fix.
      - If not, reports invalid format without fix.
  - `processComment(context, comment)` and `create(context)`:
    - `create` obtains all comments via `sourceCode.getAllComments()` and passes them to `processComment`.
    - `processComment` handles multiline annotations and both @story and @req tags, dispatching to `validateStoryAnnotation` / `validateReqAnnotation`.
    - This ensures integration with the existing validation behavior from earlier stories while layering on safe auto-fix where appropriate.

User-facing documentation (Documentation acceptance criterion):
- user-docs/api-reference.md
  - For `traceability/require-story-annotation`:
    - Describes behavior: ensures every function has an @story annotation.
    - Documents `--fix` behavior:
      - "When run with `--fix`, the rule inserts a single-line placeholder JSDoc `@story` annotation above missing functions, methods, TypeScript declare functions, and interface method signatures using a built-in template aligned with Story 008.0. This template is currently fixed but structured for future configurability, and fixes are strictly limited to adding this placeholder annotation without altering the function body or changing any runtime behavior."
    - This matches the actual code in require-story-helpers and require-story-core, and aligns with REQ-AUTOFIX-MISSING, REQ-AUTOFIX-SAFE, and REQ-AUTOFIX-PRESERVE.
  - For `traceability/valid-annotation-format`:
    - Describes validation of annotation format.
    - Specifically documents `--fix` behavior:
      - Limited to safe `@story` path suffix normalization only (e.g., adding `.md` when `.story` is present, or `.story.md` when missing entirely).
      - Refers directly to `getFixedStoryPath` and `reportInvalidStoryFormatWithFix` as the underlying helpers.
      - States that directories are not changed, new story names are not inferred, and surrounding comment text/whitespace is not modified, exactly matching the implementation.
  - The file includes the required user-docs attribution line: "Created autonomously by voder.ai" and is clearly targeted at plugin users.

Automated tests:
- Project test command (from package.json):
  - "test": "jest --ci --bail".
- Executed:
  - `npm test -- --ci --bail --runInBand`.
- Output:
  - `> eslint-plugin-traceability@1.0.5 test`
  - `> jest --ci --bail --ci --bail --runInBand`
  - No failures reported; jest completed successfully, which includes running tests/rules/auto-fix-behavior-008.test.ts and all related rule tests.

Requirements not in scope for this iteration (explicitly marked as not yet implemented in the story):
- REQ-AUTOFIX-TEMPLATE: Configurable annotation templates.
- REQ-AUTOFIX-SELECTIVE: Per-fix-type enable/disable controls beyond standard ESLint rule enable/disable.
The story text explicitly marks these as "Not yet implemented" and describes them as future enhancements, so their absence is consistent with the current iteration and does not count as a failure for this assessment.</evidence>
  <notes>All in-scope acceptance criteria and requirements for Story docs/stories/008.0-DEV-AUTO-FIX.story.md are implemented and verified. The `traceability/require-story-annotation` rule supports auto-fixing missing @story annotations for functions, methods, TypeScript declare functions, and interface method signatures using a conservative, built-in placeholder template. The `traceability/valid-annotation-format` rule implements safe, minimal auto-fix behavior limited to normalizing @story path suffixes (.story/.md/.story.md) through well-scoped helpers that preserve surrounding formatting and avoid ambiguous or unsafe transformations. Dedicated tests in tests/rules/auto-fix-behavior-008.test.ts, along with supporting rule tests, validate before/after behavior for both missing-annotation and path-format scenarios. User-facing documentation in user-docs/api-reference.md accurately describes the auto-fix capabilities, constraints, and safety guarantees for each rule. Jest test suite runs successfully via the project’s npm test command, confirming behavior. Requirements explicitly marked in the story as future work (configurable templates and selective per-fix-type toggles) are correctly not implemented and are out of scope for this iteration. Therefore, the story is fully satisfied for the current release and is marked PASSED.</notes>
</traceability>