<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md</specification>
  <status>FAILED</status>
  <last_validated>2025-11-21T00:25:32.341Z</last_validated>
  <last_modified>2025-11-20T08:52:45.534Z</last_modified>
  <evidence>Story: docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md

Implemented code and tests:
- Core @story rule implementation:
  - src/rules/require-story-annotation.ts
    - ESLint RuleModule with meta, messages, schema, and create(context) using helpers.
    - Uses buildVisitors(...) from src/rules/helpers/require-story-visitors.ts and shouldProcessNode(...) from src/rules/helpers/require-story-helpers.ts.
- Visitor and helper logic:
  - src/rules/helpers/require-story-visitors.ts
    - Builds visitors for FunctionDeclaration, FunctionExpression, ArrowFunctionExpression, MethodDefinition, TSDeclareFunction, TSMethodSignature.
    - ArrowFunctionExpression handler (handleArrowFunctionExpression) calls helperReportMissing, i.e. arrow functions are enforced.
  - src/rules/helpers/require-story-helpers.ts
    - JSDoc / comment parsing helpers: jsdocHasStory, commentsBeforeHasStory, leadingCommentsHasStory, linesBeforeHasStory, parentChainHasStory, fallbackTextBeforeHasStory.
    - Scope and export priority: DEFAULT_SCOPE (includes "ArrowFunctionExpression" and other function-like nodes) and shouldProcessNode(node, scope, exportPriority) implementing exportPriority = all|exported|non-exported.
    - Reporting helpers: reportMissing and reportMethod use context.report with messageId "missingStory" and suggestions that insert ANNOTATION (/** @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md */) before the chosen target.
  - src/rules/helpers/require-story-core.ts
    - DEFAULT_SCOPE includes: FunctionDeclaration, FunctionExpression, ArrowFunctionExpression, MethodDefinition, TSMethodSignature, TSDeclareFunction, VariableDeclarator.
    - createAddStoryFix and createMethodFix implement autofixes; reportMissing/reportMethod construct messages and suggestions (but see mismatch below).
- @req rule and helpers:
  - src/rules/require-req-annotation.ts
    - Separate ESLint rule enforcing @req, not combined with @story into one rule.
    - Handles FunctionDeclaration directly; delegates TSDeclareFunction and TSMethodSignature to checkReqAnnotation.
  - src/utils/annotation-checker.ts
    - getJsdocComment, getLeadingComments, getCommentsBefore, combineComments, hasReqAnnotation, createMissingReqFix, reportMissing, and checkReqAnnotation.
    - Parses JSDoc and nearby comments to determine presence of @req and reports/fixes when missing (including TypeScript nodes).
- Plugin integration:
  - src/index.ts
    - RULE_NAMES includes "require-story-annotation" and "require-req-annotation".
    - configs.recommended and configs.strict enable both rules, so both @story and @req are enforced in preset use.

Tests (all passing via `npm test -- --ci --no-watch --runInBand --verbose`):
- Core rule behavior and configuration:
  - tests/rules/require-story-annotation.test.ts
    - Valid cases: functions, function expressions, arrow functions, class methods, TSDeclareFunction, TSMethodSignature with @story.
    - Invalid cases include:
      - Missing @story on plain function, function expression, arrow function, class method, TSDeclareFunction, TSMethodSignature.
    - Tests exportPriority option: exported vs non-exported.
    - Tests scope option to restrict checks (e.g. only FunctionDeclaration) and ensure arrow functions are ignored only when excluded by scope option.
- Helper and edge-case coverage:
  - tests/rules/require-story-helpers.test.ts
  - tests/rules/require-story-helpers-edgecases.test.ts
  - tests/rules/require-story-io-behavior.test.ts
  - tests/rules/require-story-io.edgecases.test.ts
  - tests/rules/require-story-core.test.ts
  - tests/rules/require-story-core.autofix.test.ts
  - tests/rules/require-story-visitors-edgecases.test.ts
    - Exercise malformed/missing JSDoc, missing APIs (getCommentsBefore/getText), various range/loc shapes, and autofix logic.
- @req rule tests:
  - tests/rules/require-req-annotation.test.ts
    - Valid: function with @req only, function with @story+@req, TSDeclareFunction and TSMethodSignature with @req.
    - Invalid: missing @req in multiple scenarios; confirm fix to insert "/** @req <REQ-ID> */\n".

Rule documentation:
- docs/rules/require-story-annotation.md
  - Describes the rule, supported node types (including ArrowFunctionExpression), options schema (scope, exportPriority), JS and TS examples.
  - References @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md and @req REQ-ANNOTATION-REQUIRED.
- docs/rules/require-req-annotation.md
  - Describes `require-req-annotation` rule, behavior, examples for JS and TS.
  - Also references the same story and requirement.

Key mismatches with the story specification:
1) Arrow functions are enforced, but the story says they must be excluded:
   - Story requirements:
     - REQ-FUNCTION-DETECTION: "Detect function declarations and function expressions (excluding arrow functions)."
   - Implementation and tests:
     - DEFAULT_SCOPE includes "ArrowFunctionExpression".
     - buildArrowFunctionVisitor and handleArrowFunctionExpression actively enforce @story on arrow functions.
     - docs/rules/require-story-annotation.md lists ArrowFunctionExpression in supported node types.
     - tests/rules/require-story-annotation.test.ts includes invalid cases for arrow functions missing @story, asserting they are errors.
   - This directly contradicts the specification, which explicitly excludes arrow functions from traceability requirements.

2) Error location and message content do not fully match REQ-ERROR-LOCATION and UX details:
   - Story: "Report errors at function name for precise error location" and "Provide clear error messages that include function name and missing annotation type."
   - Implementation:
     - src/rules/require-story-annotation.ts meta.messages.missingStory = "Missing @story annotation (REQ-ANNOTATION-REQUIRED)": no function name interpolation.
     - reportMissing and reportMethod (helpers) compute `name` and use it only in suggestion descriptions (desc: "Add JSDoc @story annotation for function 'name', e.g., ...").
     - context.report `node` is the function/method node; no explicit targeting of the Identifier node for precise function-name location.
     - For `require-req-annotation`, message is simply "Missing @req annotation", again without function name and without relocated error position.
   - So while suggestions mention the function name, the primary lint error message and its location do not satisfy the specification requirement.

3) Single core rule vs. two separate rules for @story and @req:
   - Story text: "This story implements the core ESLint rule that validates functions have proper @story and @req annotations" and REQ-ANNOTATION-REQUIRED: "Require both @story and @req annotations on functions."
   - Implementation splits enforcement into two independent rules: `require-story-annotation` and `require-req-annotation`.
   - Enabling both via recommended/strict configs enforces both annotations in practice, but this differs from the specified design of a single core rule validating both aspects together.

4) Minor divergence from Implementation Notes:
   - Story suggests using @typescript-eslint/utils for AST parsing; implementation uses ESLint's core Rule types and APIs instead. This is not critical to behavior but does not follow the implementation note.

Given these concrete discrepancies (especially enforcement on arrow functions contrary to spec and lack of name-based error location/messages), the story 003.0-DEV-FUNCTION-ANNOTATIONS cannot be considered fully implemented as specified.</evidence>
  <notes>The repository implements substantial functionality for function traceability: a `require-story-annotation` rule with rich helper logic, a `require-req-annotation` rule, comprehensive tests (all passing), documentation, and integration into recommended/strict ESLint configs. However, the implementation diverges from the story in important ways:

- Arrow functions are explicitly enforced by the rule and documented as such, while the story requires that arrow functions be excluded from traceability requirements (REQ-FUNCTION-DETECTION and the Implementation Notes).
- Error reporting does not meet REQ-ERROR-LOCATION or the UX description: the primary messages do not include the function name, and error locations are not specifically attached to the function name identifier.
- The story describes a single core rule validating both @story and @req annotations, but the implementation splits this into two separate rules.

Because these mismatches violate explicit requirements and acceptance criteria, the correct assessment for this story is FAILED, despite the otherwise robust implementation and passing test suite.</notes>
</traceability>