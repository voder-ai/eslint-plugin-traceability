<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md</specification>
  <status>FAILED</status>
  <last_validated>2025-11-21T07:38:57.631Z</last_validated>
  <last_modified>2025-11-20T08:52:45.534Z</last_modified>
  <evidence>Key implementation files and tests:
- Story file present: docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md.
- Core @story rule:
  - src/rules/require-story-annotation.ts implements the ESLint rule `require-story-annotation`.
  - Uses helpers in src/rules/helpers/require-story-helpers.ts and src/rules/helpers/require-story-core.ts.
  - DEFAULT_SCOPE in require-story-core.ts = ["FunctionDeclaration", "FunctionExpression", "MethodDefinition", "TSMethodSignature", "TSDeclareFunction"]. Arrow functions are not included in the default scope, matching the story’s exclusion.
  - Meta.schema supports configurable `scope` and `exportPriority`.
  - Error message: messageId "missingStory" with data { name } and a clear suggestion using the concrete story path.
- @story detection & robustness:
  - src/rules/helpers/require-story-helpers.ts provides jsdocHasStory, commentsBeforeHasStory, leadingCommentsHasStory, linesBeforeHasStory, parentChainHasStory, fallbackTextBeforeHasStory, hasStoryAnnotation, resolveTargetNode, extractName, shouldProcessNode, reportMissing, reportMethod.
  - src/rules/helpers/require-story-io.ts encapsulates IO-heavy helper logic and handles malformed inputs in try/catch blocks.
- @req rule:
  - src/rules/require-req-annotation.ts exports a rule requiring @req, tagged with this story.
  - Meta:
    - messages.missingReq: "Missing @req annotation for function '{{name}}' (REQ-ANNOTATION-REQUIRED)".
    - schema: [] (no options), so there is NO configurable scope or exportPriority for @req.
  - create(context) listeners:
    - FunctionDeclaration(node) → checkReqAnnotation(context, node).
    - TSDeclareFunction(node) → checkReqAnnotation(context, node).
    - TSMethodSignature(node) → checkReqAnnotation(context, node).
    - There are NO listeners for FunctionExpression, MethodDefinition, or ArrowFunctionExpression.
- @req detection logic:
  - src/utils/annotation-checker.ts (used by require-req-annotation):
    - hasReqAnnotation checks jsdoc.value and combined leading/before comments for "@req".
    - checkReqAnnotation(context, node) calls reportMissing(context, node) when hasReqAnnotation is false.
    - reportMissing uses getNodeName(node) and reports with messageId "missingReq" and a fix inserting "/** @req <REQ-ID> */\n" before the node.
- Tests specifically tied to this story:
  - tests/rules/require-story-annotation.test.ts:
    - Header: "Tests for: docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md" and @story annotation.
    - Valid cases:
      - FunctionDeclaration, FunctionExpression, ArrowFunctionExpression (with @story), MethodDefinition, TSDeclareFunction, TSMethodSignature.
      - Confirms unannotated arrow functions are allowed by default.
    - Invalid cases:
      - Missing @story on FunctionDeclaration, FunctionExpression, MethodDefinition, TSDeclareFunction, TSMethodSignature, with expected auto-fix outputs and suggestion messages.
    - Additional runs cover `exportPriority` (exported vs non-exported) and `scope` options.
  - tests/rules/require-story-core.test.ts and tests/rules/require-story-core-edgecases.test.ts:
    - Exercise createAddStoryFix, createMethodFix, and reportMissing/reportMethod edge cases, including export parent range handling and fallback behaviors.
  - tests/rules/require-story-helpers-edgecases.test.ts:
    - Exercise jsdocHasStory, commentsBeforeHasStory, leadingCommentsHasStory, resolveTargetNode, shouldProcessNode (exportPriority), and ensure reportMissing doesn’t report when a preceding @story is found via linesBeforeHasStory.
  - tests/rules/require-req-annotation.test.ts:
    - Header ties to docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md.
    - Valid @req coverage:
      - FunctionDeclaration with @req (and with @story + @req).
      - TSDeclareFunction and TSMethodSignature with @req.
    - Invalid coverage:
      - FunctionDeclaration with no JSDoc.
      - FunctionDeclaration with only @story.
      - TSDeclareFunction without @req.
      - TSMethodSignature without @req.
    - No tests for FunctionExpression or MethodDefinition with respect to @req.
- Plugin integration and docs:
  - src/index.ts includes both rules in RULE_NAMES and in configs.recommended/strict ("traceability/require-story-annotation" and "traceability/require-req-annotation": "error").
  - docs/rules/require-story-annotation.md and docs/rules/require-req-annotation.md both reference @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md and document rule purpose and examples.
- Test execution:
  - Command run: npm test -- --ci --bail --runInBand --verbose.
  - Output shows Jest executing tests and debug messages from require-story-annotation, with no failures reported, indicating all story-related tests currently pass.</evidence>
  <notes>The implementation robustly covers @story annotations for functions and methods via the `require-story-annotation` rule, including TypeScript support, configurable scope and export priority, clear error messages, auto-fix and suggestions, and extensive tests and documentation. However, the story explicitly requires that functions have both @story and @req annotations (REQ-ANNOTATION-REQUIRED) and that function detection includes function declarations and function expressions (excluding arrow functions) with configurable scope and export-priority. The `require-req-annotation` rule, which is tagged to this same story, only enforces @req on FunctionDeclaration, TSDeclareFunction, and TSMethodSignature, with no listeners for FunctionExpression or MethodDefinition and no options for scope or exportPriority (schema is []). Thus, function expressions and methods can lack @req annotations without being flagged, and the @req enforcement cannot be configured in the same way as @story enforcement. These gaps contradict REQ-FUNCTION-DETECTION, REQ-ANNOTATION-REQUIRED (for @req across all relevant function kinds), and REQ-CONFIGURABLE-SCOPE/REQ-EXPORT-PRIORITY at the story level. Since these discrepancies are evident in the current code and tests, the story is only partially implemented and the assessment status is FAILED.</notes>
</traceability>