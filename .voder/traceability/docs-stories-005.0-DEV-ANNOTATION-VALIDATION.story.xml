<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T22:18:14.781Z</last_validated>
  <last_modified>2025-11-21T04:06:15.904Z</last_modified>
  <evidence>Implementation:
- Core rule file: src/rules/valid-annotation-format.ts
  - File header ties directly to this story and requirements:
    - @story docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story.md
    - @req REQ-FORMAT-SPECIFICATION, REQ-SYNTAX-VALIDATION, REQ-PATH-FORMAT, REQ-REQ-FORMAT, REQ-MULTILINE-SUPPORT, REQ-FLEXIBLE-PARSING, REQ-ERROR-SPECIFICITY
  - Normalization and parsing helpers:
    - normalizeCommentLine(rawLine: string): trims, strips leading '*', preserves annotation tags anywhere in the line → supports flexible formats.
    - collapseAnnotationValue(value: string): removes all internal whitespace so multi-line annotations form a single logical value.
  - Validation logic:
    - validateStoryAnnotation(context, comment, rawValue):
      - Empty trimmed value → reports messageId "invalidStoryFormat" with details from buildStoryErrorMessage("missing", null).
      - Collapses whitespace and checks against:
        - pathPattern: /^docs\/stories\/[0-9]+\.[0-9]+-DEV-[\w-]+\.story\.md$/
        - Enforces docs/stories/NNN.N-DEV-NAME.story.md (REQ-PATH-FORMAT, REQ-FORMAT-SPECIFICATION).
      - Rejects values containing whitespace after collapse, reports specific invalid message.
      - Attempts safe suffix-normalization via getFixedStoryPath (handles .story → .story.md, .md → .story.md, missing suffix → .story.md, but skips any path with ".." to prevent traversal) and, when valid, uses reportInvalidStoryFormatWithFix to apply a minimal fix to the comment text.
    - validateReqAnnotation(context, comment, rawValue):
      - Empty value → invalidReqFormat with missing-ID details from buildReqErrorMessage.
      - Uses reqPattern: /^REQ-[A-Z0-9-]+$/ to enforce REQ-* uppercase identifier format (REQ-REQ-FORMAT).
      - Reports invalid IDs with explicit details including offending value.
  - Comment processing:
    - processComment(context, comment):
      - Splits comment.value into lines, normalizes each line.
      - Detects @story/@req via regex, creates a PendingAnnotation with type and initial value after the tag.
      - Accumulates subsequent normalized lines as continuation of the pending annotation (multi-line support).
      - finalizePending dispatches to validateStoryAnnotation or validateReqAnnotation based on pending.type.
      - Handles empty lines and non-annotation lines gracefully.
  - Rule module wiring:
    - meta: { type: "problem", docs.description: "Validate format and syntax of @story and @req annotations", messages: { invalidStoryFormat, invalidReqFormat }, schema: [], fixable: "code" }
    - create(context): obtains sourceCode and inspects all comments via sourceCode.getAllComments(), applying processComment to each → integrates with any rule that relies on comment-based annotations.

Integration:
- src/index.ts:
  - RULE_NAMES includes "valid-annotation-format" so it is exported as part of the plugin.
  - configs.recommended and configs.strict both configure:
    - "traceability/valid-annotation-format": "warn"
  - Ensures this validation runs alongside require-story-annotation and require-branch-annotation when users use the provided configs.

Tests:
- tests/rules/valid-annotation-format.test.ts:
  - Header:
    - Tests for: docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story.md
    - @story docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story.md
    - @req REQ-FORMAT-SPECIFICATION - Verify valid-annotation-format rule enforces annotation format syntax
  - Uses RuleTester with ECMAScript 2020 parser options.
  - Valid cases verify:
    - Correct single-line @story path: // @story docs/stories/005.0-DEV-ANNOTATION-VALIDATION.story.md
    - Correct single-line @req: // @req REQ-EXAMPLE
    - Block comments with both @story and @req.
    - Multi-line @story value split across lines.
    - Multi-line @req value split across lines.
    - JSDoc-style comments with leading '*' and extra whitespace (flexible parsing).
  - Invalid cases verify:
    - Missing story path: // @story → invalidStoryFormat with specific "Missing story path..." details.
    - Invalid story file extension and missing suffix, including expected auto-fixed output.
    - Path traversal with ../docs/... is rejected with invalid story path error and no fix.
    - Missing req id (// @req, // @req[space]) & invalid IDs (e.g. "invalid-format").
    - Missing and invalid multi-line @story and @req values after collapsing whitespace.
- Test execution evidence:
  - Global run: `npm test -- --ci --no-watch --runInBand --verbose` executed Jest with this rule among others; no failures reported in the captured output.
  - Focused run: `npm test -- --runTestsByPath tests/rules/valid-annotation-format.test.ts --verbose` completed without test failures, indicating all the above behavioral checks pass.

Documentation:
- docs/rules/valid-annotation-format.md:
  - Directly references the story and requirements via @story and @req tags.
  - Explicitly documents:
    - @story regex: ^docs/stories/[0-9]+\.[0-9]+-DEV-[\w-]+\.story\.md$
    - @req regex: ^REQ-[A-Z0-9-]+$
    - Flexible parsing across line, block, and JSDoc comments.
    - Multiline annotation behavior and normalization.
    - Types of error messages for missing and invalid annotations with examples.
  - Provides correct and incorrect examples consistent with the story’s format examples.</evidence>
  <notes>The story 005.0-DEV-ANNOTATION-VALIDATION is fully implemented. There is a dedicated ESLint rule (valid-annotation-format) that validates @story and @req annotation syntax against clearly defined patterns, supports multi-line and flexible comment formats, and reports detailed, specific error messages for different violation types. This rule is wired into the plugin export and recommended/strict configs, so it integrates with function and branch annotation rules. Comprehensive tests cover all key requirements (path format, req format, multiline support, flexible parsing, and error specificity) and pass successfully. Documentation in docs/rules/valid-annotation-format.md clearly specifies the annotation format rules and examples. Together, this satisfies all stated acceptance criteria and requirements for the story.</notes>
</traceability>