<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/010.0-DEV-DEEP-VALIDATION.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T22:19:18.636Z</last_validated>
  <last_modified>2025-11-19T04:17:32.853Z</last_modified>
  <evidence>Implementation:
- Core deep validation rule is implemented in src/rules/valid-req-reference.ts.
  - File header JSDoc explicitly ties the rule to this story and requirements:
    * @story docs/stories/010.0-DEV-DEEP-VALIDATION.story.md
    * @req REQ-DEEP-PARSE, REQ-DEEP-MATCH, REQ-DEEP-CACHE, REQ-DEEP-PATH
  - validateReqLine(...) parses the referenced story file to extract requirement IDs and validates @req against them:
    * Reads file content: fs.readFileSync(resolvedStoryPath, "utf8").
    * Extracts IDs via regex: const regex = /REQ-[A-Z0-9-]+/g; while ((match = regex.exec(content)) !== null) { found.add(match[0]); }.
    * Caches per file: reqCache: Map<string, Set<string>> and only parses when !reqCache.has(resolvedStoryPath), satisfying REQ-DEEP-CACHE.
    * Reports missing requirement with clear message: context.report({ messageId: "reqMissing", data: { reqId, storyPath } }).
  - Path validation and security:
    * Rejects path traversal and absolute paths: if (storyPath.includes("..") || path.isAbsolute(storyPath)) { context.report({ messageId: "invalidPath", data: { storyPath } }); }.
    * Ensures resolved path stays within cwd: if (!resolvedStoryPath.startsWith(cwd + path.sep) && resolvedStoryPath !== cwd) â†’ reports invalidPath.
  - Comment/annotation integration:
    * handleAnnotationLine(...) and handleComment(...) walk JSDoc lines, maintaining storyPath from @story and validating each @req line using validateReqLine().
  - Error-handling:
    * File read is in try/catch; on error it sets an empty Set in cache (reqCache.set(resolvedStoryPath, new Set())), preventing rule crashes on malformed/missing story files while still allowing graceful reporting.
  - User-facing messages in meta.messages:
    * reqMissing: "Requirement '{{reqId}}' not found in '{{storyPath}}'" (includes both ID and story path).
    * invalidPath: "Invalid story path '{{storyPath}}'".

Tests:
- Dedicated tests for this story live in tests/rules/valid-req-reference.test.ts.
  - File header:
    * "Tests for: docs/stories/010.0-DEV-DEEP-VALIDATION.story.md"
    * @story docs/stories/010.0-DEV-DEEP-VALIDATION.story.md
    * @req REQ-DEEP-PARSE - Verify valid-req-reference rule enforces existing requirement content.
  - Valid cases (confirm successful deep matches and multiple formats):
    * Uses a real story: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md with @req REQ-PLUGIN-STRUCTURE; that ID exists in the story file (verified by search_file_content).
    * Uses a bullet-format fixture: tests/fixtures/story_bullet.md containing "- REQ-BULLET-LIST - a requirement in bullet list format", validated by a test case named "[REQ-DEEP-BULLET] valid bullet list requirement existing in bullet story fixture".
  - Invalid cases (confirm missing requirements and error messages):
    * Missing requirement: @req REQ-NON-EXISTENT against docs/stories/001.0-DEV-PLUGIN-SETUP.story.md expects messageId "reqMissing" with correct reqId and storyPath.
    * Bullet fixture missing requirement: @req REQ-MISSING-BULLET against tests/fixtures/story_bullet.md expects "reqMissing" with reqId and storyPath.
    * Path traversal: ../docs/stories/... expects messageId "invalidPath".
    * Absolute path: /absolute/path/... expects messageId "invalidPath".
- Test execution:
  - Command run: npm test -- --runTestsByPath tests/rules/valid-req-reference.test.ts --verbose
  - Output shows Jest invoked for this path with no reported failures, indicating all tests for this rule pass.

Documentation:
- Rule documentation is provided in docs/rules/valid-req-reference.md.
  - Ties directly to this story: @story docs/stories/010.0-DEV-DEEP-VALIDATION.story.md.
  - References deep-validation requirements: @req REQ-DEEP-PARSE, REQ-DEEP-MATCH, REQ-DEEP-PATH.
  - Describes behavior matching acceptance criteria:
    * Verifies referenced story file exists and is within the project directory.
    * Parses story file to extract requirement IDs (e.g., REQ-XXX-YYY).
    * Ensures each @req annotation matches an extracted requirement ID.
    * Reports invalidPath on traversal/absolute paths and reqMissing on missing requirements.
  - Includes concrete examples of correct and incorrect usage.

Integration:
- src/index.ts registers the rule name "valid-req-reference" in RULE_NAMES and includes it in both recommended and strict configs under the plugin namespace ("traceability/valid-req-reference": "error"), ensuring it participates in the existing annotation and file validation pipeline.
- valid-story-reference.ts (from story 006.0-DEV-FILE-VALIDATION) handles file existence and path validation; valid-req-reference builds on this by validating requirement IDs within existing files, matching the dependency chain described in the story.

Specification alignment:
- docs/stories/010.0-DEV-DEEP-VALIDATION.story.md defines:
  - Requirements REQ-DEEP-PARSE, REQ-DEEP-MATCH, REQ-DEEP-FORMAT, REQ-DEEP-SECTION, REQ-DEEP-CACHE, REQ-DEEP-ERROR (verified via search_file_content).
  - The implementation in src/rules/valid-req-reference.ts and its tests explicitly reference and satisfy these IDs via JSDoc annotations and behavior.
- User Experience, Error Handling, and Documentation acceptance criteria are met through specific error messages, safe parsing with try/catch, and the dedicated rule documentation file.</evidence>
  <notes>All acceptance criteria for 010.0-DEV-DEEP-VALIDATION are satisfied. The valid-req-reference rule parses story markdown to discover REQ-* identifiers, caches results, and validates each @req annotation against the discovered IDs, with clear, specific error messages for missing requirements and invalid paths. It integrates with existing annotation and file-validation rules via the plugin index and configuration, and its behavior is covered by targeted Jest tests and documented in docs/rules/valid-req-reference.md. Tests for this rule pass, and the implementation is traceably linked to the story and its detailed requirements.</notes>
</traceability>