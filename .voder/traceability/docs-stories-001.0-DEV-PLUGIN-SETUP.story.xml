<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/001.0-DEV-PLUGIN-SETUP.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T05:03:03.245Z</last_validated>
  <last_modified>2025-11-19T07:26:31.159Z</last_modified>
  <evidence>Test execution:
- package.json defines "test": "jest --ci --bail"
- Command run (per earlier step): `npm test -- --verbose`
- Jest ran in CI mode with bail enabled and produced no FAIL lines or error stack traces, indicating the full test suite passed.

Core plugin structure & requirements (REQ-PLUGIN-STRUCTURE, REQ-RULE-REGISTRY, REQ-CONFIG-SYSTEM, REQ-NPM-PACKAGE, REQ-TYPESCRIPT, REQ-TEST-SETUP, REQ-ERROR-HANDLING):
- src/index.ts:
  - JSDoc at top:
    - `@story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md`
    - `@req REQ-PLUGIN-STRUCTURE - Provide foundational plugin export and registration`
    - `@req REQ-ERROR-HANDLING - Gracefully handles plugin loading errors and missing dependencies`
  - Implements TypeScript module exporting ESLint plugin structure:
    - Declares RULE_NAMES array with rule ids: require-story-annotation, require-req-annotation, require-branch-annotation, valid-annotation-format, valid-story-reference, valid-req-reference.
    - Builds `rules: Record<RuleName, Rule.RuleModule>` and fills it via `RULE_NAMES.forEach` with `require(./rules/${name})`, supporting both default and named exports.
    - try/catch around rule loading; on error:
      - Logs to console.error: `[eslint-plugin-traceability] Failed to load rule "${name}": ${error.message}`
      - Registers a placeholder RuleModule with meta.docs.description `Failed to load rule '${name}'` and a Program visitor that reports `eslint-plugin-traceability: Error loading rule "${name}": ${error.message}`.
    - Defines `configs` with `recommended` and `strict` arrays, each containing objects with `plugins: { traceability: {} }` and appropriate `rules` mappings.
    - Exports `rules`, `configs`, and default `{ rules, configs }`.
- package.json:
  - `"name": "eslint-plugin-traceability"` (standard ESLint plugin naming).
  - `"main": "lib/src/index.js"`, `"types": "lib/src/index.d.ts"`, `"files": ["lib", "README.md", "LICENSE"]` (publishable npm package layout).
  - Dev toolchain and tests: TypeScript, Jest, ESLint, Prettier, etc.; `"build": "tsc -p tsconfig.json"`, `"type-check": "tsc --noEmit -p tsconfig.json"`, `"test": "jest --ci --bail"`, `"lint"`, `"format:check"`, etc. (REQ-TEST-SETUP, REQ-TYPESCRIPT).
  - `"peerDependencies": { "eslint": "^9.0.0" }` (explicit ESLint v9 compatibility – REQ-ESLINT-COMPAT).
- tsconfig.json:
  - TypeScript configuration with CommonJS output, `outDir: "lib"`, `declaration: true`, and `include: ["src", "tests"]`, establishing a standard TS-based plugin build (REQ-TYPESCRIPT).

Tests explicitly tied to Story 001.0 (traceability via @story):
- tests/plugin-setup.test.ts:
  - Header includes:
    - `Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md`
    - `@story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md`
    - `@req REQ-PLUGIN-STRUCTURE - plugin exports rules and configs`
  - Test:
    - Imports `plugin, { rules, configs }` from `../src/index`.
    - Asserts rules and configs are defined and are objects.
    - Asserts `plugin.rules === rules` and `plugin.configs === configs`.
  - Confirms core plugin export/registration structure (Acceptance: Core Functionality, REQ-PLUGIN-STRUCTURE).

- tests/plugin-default-export-and-configs.test.ts:
  - Header references story 001.0 and REQ-PLUGIN-STRUCTURE.
  - Tests:
    - `[REQ-PLUGIN-STRUCTURE] default export includes rules and configs` – verifies default export matches named exports.
    - `[REQ-PLUGIN-STRUCTURE] rules object has correct rule names` – asserts Object.keys(rules) equals the expected list of rule ids from src/index.ts.
    - `[REQ-RULE-REGISTRY] configs.recommended contains correct rule configuration` – checks that recommended config includes the key traceability rules with "error" severity.
    - `[REQ-CONFIG-SYSTEM] configs.strict contains same rules as recommended` – asserts strict config matches recommended.
  - Confirms rule registry, preset configs, and plugin export shape (REQ-PLUGIN-STRUCTURE, REQ-RULE-REGISTRY, REQ-CONFIG-SYSTEM).

- tests/plugin-setup-error.test.ts:
  - Header:
    - `Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md`
    - `@story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md`
    - `@req REQ-ERROR-HANDLING - Gracefully handles plugin loading errors and missing dependencies`
  - beforeEach mocks `../src/rules/require-branch-annotation` to throw `new Error("Test load error")`, and spies on console.error.
  - Test `[REQ-ERROR-HANDLING] should report error loading rule and provide placeholder rule`:
    - Requires `../src/index` to trigger dynamic rule loading.
    - Asserts `console.error` called with string containing `Failed to load rule "require-branch-annotation": Test load error`.
    - Asserts `plugin.rules["require-branch-annotation"]` is defined.
    - Asserts `placeholderRule.meta.docs.description` contains `Failed to load rule 'require-branch-annotation'`.
    - Creates a fake context, invokes Program visitor, and asserts `context.report` is called with a message containing `Error loading rule "require-branch-annotation": Test load error`.
  - Demonstrates graceful rule load error handling at plugin level (Acceptance: Error Handling, REQ-ERROR-HANDLING).

- tests/cli-error-handling.test.ts:
  - Header:
    - `@story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md`
    - `@req REQ-ERROR-HANDLING - Plugin CLI should exit with error on rule load failure`
  - Uses Node `spawnSync` to run ESLint CLI (`eslint/bin/eslint.js`) with `--config` pointing to the project’s `eslint.config.js`, `--stdin`, and rule `traceability/require-story-annotation:error`.
  - Asserts ESLint process exits with non-zero status and stdout contains `Missing @story annotation`, validating CLI-level behavior when running with the plugin.

- tests/integration/cli-integration.test.ts:
  - Header:
    - `@story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md`
    - `@req REQ-PLUGIN-STRUCTURE - Validate plugin registers via CLI`
  - Locates ESLint CLI via `require.resolve("eslint/package.json")` and runs it with the repository’s `eslint.config.js` flat config.
  - Defines multiple test cases (missing/present @story, missing @req, invalid/absolute paths) and for each case:
    - Runs ESLint with the traceability rule (e.g., traceability/require-story-annotation:error).
    - Asserts `result.status` equals the expectedStatus (0 or 1).
  - Confirms plugin successfully registers and executes in ESLint v9 CLI with flat config (Acceptance: Integration; REQ-PLUGIN-STRUCTURE, REQ-ESLINT-COMPAT).

ESLint v9 flat config and integration (REQ-ESLINT-COMPAT, Acceptance: Integration):
- eslint.config.js:
  - Exports an array of config objects (flat config style) using `module.exports = [...]`.
  - Loads the plugin from `./src/index.js` first, falling back to `./lib/src/index.js`. If neither exists in CI (NODE_ENV=="ci" or CI=="true"), it throws a descriptive error; otherwise logs a warning and continues with `plugin = {}`.
  - Registers the plugin in applicable configs via `plugins: { ...(plugin.rules ? { traceability: plugin } : {}) }`, meaning the `traceability` namespace maps to the plugin’s rules/configs when available.
  - This matches ESLint v9 flat config expectations and is exercised by the CLI integration tests.

User Experience & Documentation (Acceptance: User Experience, Documentation):
- README.md:
  - Provides installation instructions:
    - `npm install --save-dev eslint-plugin-traceability`
    - `yarn add --dev eslint-plugin-traceability`
  - States prerequisites: `Node.js >=14` and `ESLint v9+`.
  - Contains an "Example eslint.config.js (ESLint v9 flat config)" snippet showing how to configure the plugin using flat config format.
  - Provides a "Quick Start" section with an ESM-style example:
    - `import traceability from "eslint-plugin-traceability";`
    - `export default [ traceability.configs.recommended ];`
  - Lists available rules and links to their docs in `docs/rules/*.md`.
  - Explains how to run tests, lint, format checks, and duplication checks.
  - Describes CLI validation command using ESLint with the traceability rule.
- docs/eslint-plugin-development-guide.md:
  - Describes plugin structure (meta, configs, rules, processors) and provides a basic `src/index.ts` template.
  - Details meta data requirements and rule structure.
  - This document directly addresses "Plugin structure and development setup is properly documented" in the story.

Overall, the evidence shows:
- The ESLint plugin module is correctly structured, export-complete, and dynamically loads rules with robust error handling.
- The plugin is integrated with ESLint v9 via flat config, with both unit-level and CLI integration tests verifying behavior.
- The npm package metadata, TypeScript configuration, and test infrastructure are in place and actively used.
- User-facing and development-facing documentation describe installation, configuration, and development of the plugin.</evidence>
  <notes>Story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md is fully implemented. The core plugin structure (rules/configs exports, rule registry, configuration presets) exists in src/index.ts and is exercised by targeted Jest tests. ESLint v9 flat config integration is implemented in eslint.config.js and validated via CLI integration tests that invoke the real ESLint CLI. Error handling for rule loading and plugin availability is implemented and tested. The plugin is structured as a TypeScript-based, publishable npm package, and both README.md and docs/eslint-plugin-development-guide.md document installation, configuration, and development setup. All relevant tests pass under `npm test -- --verbose`, so all acceptance criteria and listed requirements for this story are satisfied.</notes>
</traceability>