<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/001.0-DEV-PLUGIN-SETUP.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T22:18:35.511Z</last_validated>
  <last_modified>2025-11-19T07:26:31.159Z</last_modified>
  <evidence>Story file exists: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md.

Core plugin structure & rule registry (REQ-PLUGIN-STRUCTURE, REQ-RULE-REGISTRY):
- src/index.ts defines the plugin entry point, exporting rules and configs and dynamically loading rule modules:
  """ts
  /**
   * ESLint Traceability Plugin
   * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-PLUGIN-STRUCTURE - Provide foundational plugin export and registration
   * @req REQ-ERROR-HANDLING - Gracefully handles plugin loading errors and missing dependencies
   */
  import type { Rule } from "eslint";

  const RULE_NAMES = [
    "require-story-annotation",
    "require-req-annotation",
    "require-branch-annotation",
    "valid-annotation-format",
    "valid-story-reference",
    "valid-req-reference",
  ] as const;

  type RuleName = (typeof RULE_NAMES)[number];
  const rules: Record<RuleName, Rule.RuleModule> = {} as any;

  RULE_NAMES.forEach((name) => {
    try {
      const mod = require(`./rules/${name}`);
      rules[name] = mod.default ?? mod;
    } catch (error: any) {
      console.error(
        `[eslint-plugin-traceability] Failed to load rule "${name}": ${error.message}`,
      );
      rules[name] = {
        meta: {
          type: "problem",
          docs: { description: `Failed to load rule '${name}'` },
          schema: [],
        },
        create(context: Rule.RuleContext) {
          return {
            Program(node: any) {
              context.report({
                node,
                message: `eslint-plugin-traceability: Error loading rule "${name}": ${error.message}`,
              });
            },
          };
        },
      } as Rule.RuleModule;
    }
  });

  const configs = {
    recommended: [
      {
        plugins: { traceability: {} },
        rules: {
          "traceability/require-story-annotation": "error",
          "traceability/require-req-annotation": "error",
          "traceability/require-branch-annotation": "error",
          "traceability/valid-annotation-format": "warn",
          "traceability/valid-story-reference": "error",
          "traceability/valid-req-reference": "error",
        },
      },
    ],
    strict: [
      {
        plugins: { traceability: {} },
        rules: {
          "traceability/require-story-annotation": "error",
          "traceability/require-req-annotation": "error",
          "traceability/require-branch-annotation": "error",
          "traceability/valid-annotation-format": "warn",
          "traceability/valid-story-reference": "error",
          "traceability/valid-req-reference": "error",
        },
      },
    ],
  };

  export { rules, configs };
  export default { rules, configs };
  """
- This satisfies a standard ESLint plugin structure (rules object, configs presets, default export) and provides a registry for multiple rules via RULE_NAMES.

Tests tied directly to Story 001.0 confirming plugin exports and rule registry:
- tests/plugin-setup.test.ts:
  """ts
  /**
   * Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-PLUGIN-STRUCTURE - plugin exports rules and configs
   */
  import plugin, { rules, configs } from "../src/index";

  describe("Traceability ESLint Plugin (Story 001.0-DEV-PLUGIN-SETUP)", () => {
    it("[REQ-PLUGIN-STRUCTURE] plugin exports rules and configs", () => {
      expect(rules).toBeDefined();
      expect(configs).toBeDefined();
      expect(typeof rules).toBe("object");
      expect(typeof configs).toBe("object");
      expect(plugin.rules).toBe(rules);
      expect(plugin.configs).toBe(configs);
    });
  });
  """
- tests/plugin-default-export-and-configs.test.ts:
  """ts
  /**
   * Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-PLUGIN-STRUCTURE - Validate plugin default export and configs in src/index.ts
   * @req REQ-RULE-REGISTRY - (via config checks)
   */
  import plugin, { rules, configs } from "../src/index";

  it("[REQ-PLUGIN-STRUCTURE] default export includes rules and configs", () => {
    expect(plugin.rules).toBe(rules);
    expect(plugin.configs).toBe(configs);
  });

  it("[REQ-PLUGIN-STRUCTURE] rules object has correct rule names", () => {
    const expected = [
      "require-story-annotation",
      "require-req-annotation",
      "require-branch-annotation",
      "valid-annotation-format",
      "valid-story-reference",
      "valid-req-reference",
    ];
    const actual = Object.keys(rules);
    expect(actual).toEqual(expected);
  });

  it("[REQ-RULE-REGISTRY] configs.recommended contains correct rule configuration", () => {
    const recommendedRules = configs.recommended[0].rules;
    expect(recommendedRules).toHaveProperty("traceability/require-story-annotation", "error");
    expect(recommendedRules).toHaveProperty("traceability/require-req-annotation", "error");
    expect(recommendedRules).toHaveProperty("traceability/require-branch-annotation", "error");
  });
  """

Error handling for plugin loading (REQ-ERROR-HANDLING, acceptance criterion already checked in story):
- src/index.ts wraps dynamic require in try/catch, logs a clear error, and installs a placeholder rule that reports a load failure through ESLint.
- tests/plugin-setup-error.test.ts explicitly references Story 001.0 and simulates a failing rule module:
  """ts
  /**
   * Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-ERROR-HANDLING - Gracefully handles plugin loading errors and missing dependencies
   */
  jest.mock("../src/rules/require-branch-annotation", () => { throw new Error("Test load error"); });
  const plugin = require("../src/index");
  expect(console.error).toHaveBeenCalledWith(
    expect.stringContaining('Failed to load rule "require-branch-annotation": Test load error'),
  );
  const placeholderRule = plugin.rules["require-branch-annotation"];
  expect(placeholderRule.meta.docs.description).toContain("Failed to load rule 'require-branch-annotation'");
  """

ESLint v9 flat config integration (REQ-ESLINT-COMPAT, Integration criterion):
- eslint.config.js uses ESLint 9 flat config style and conditionally loads the plugin from src or lib, wiring it into plugins:
  """js
  const typescriptParser = require("@typescript-eslint/parser");
  const js = require("@eslint/js");

  let plugin;
  try {
    plugin = require("./src/index.js");
  } catch {
    try {
      plugin = require("./lib/src/index.js");
    } catch {
      // CI vs local behavior handled here
    }
  }

  module.exports = [
    js.configs.recommended,
    {
      files: ["**/*.ts", "**/*.tsx"],
      languageOptions: { parser: typescriptParser, parserOptions: { project: "./tsconfig.json", tsconfigRootDir: __dirname } },
      plugins: { ...(plugin.rules ? { traceability: plugin } : {}) },
      rules: { complexity: ["error", { max: 18 }] },
    },
    // other blocks for JS, tests, ignores
  ];
  """
- tests/integration/cli-integration.test.ts invokes the real ESLint CLI with this flat config and the traceability rules, asserting expected non-zero/zero exit statuses, demonstrating working integration.

User experience & documentation (User Experience, Documentation criteria; REQ-NPM-PACKAGE, REQ-TYPESCRIPT, REQ-TEST-SETUP):
- README.md provides installation instructions (`npm install --save-dev eslint-plugin-traceability`), ESLint v9 flat config examples (both minimal plugin usage and Quick Start via `traceability.configs.recommended`), and testing commands (npm test, lint, format:check, duplication).
- user-docs/eslint-9-setup-guide.md gives a detailed ESLint v9 flat-config setup guide including how to integrate the plugin (`import traceability from "eslint-plugin-traceability"; export default [js.configs.recommended, traceability.configs.recommended];`).
- docs/eslint-plugin-development-guide.md documents the expected plugin structure, meta fields, configs, build and distribution (TypeScript -> CommonJS, npm package settings), and testing strategy.
- package.json configures the project as a publishable ESLint plugin package (`name: "eslint-plugin-traceability"`, `main: "lib/src/index.js"`, `types: "lib/src/index.d.ts"`, `peerDependencies.eslint: "^9.0.0"`, TypeScript build and test scripts), satisfying REQ-NPM-PACKAGE and REQ-TYPESCRIPT.
- Test infrastructure exists and is wired via Jest (script: "test": "jest --ci --bail") with many *.test.ts files, including those explicitly tied to this story.

Test execution:
- Running the project tests with verbose, CI-safe options completed successfully:
  Command: `npm test -- --ci --no-watch --runInBand --verbose`
  Output (abridged): Jest ran with many debug logs from rule tests and did not report any failing suites, indicating plugin setup and error-handling tests are passing.
</evidence>
  <notes>All acceptance criteria and requirements for Story 001.0-DEV-PLUGIN-SETUP are satisfied based on concrete implementation and passing tests:
- The plugin has a proper Node/ESLint-compatible structure and a rule registry (rules object populated via RULE_NAMES) with configuration presets, verified by plugin-setup tests.
- Error handling for rule loading failures is implemented in src/index.ts and thoroughly tested by plugin-setup-error and CLI error-handling tests, matching the storyâ€™s error-handling criterion.
- ESLint v9 flat config integration is implemented via eslint.config.js and exercised by CLI integration tests, demonstrating that the plugin works under flat config.
- User-facing documentation (README, ESLint 9 setup guide) and internal development docs (eslint-plugin-development-guide) clearly explain installation, configuration, plugin structure, and development workflow.
- The project is structured as a TypeScript-based, publishable npm ESLint plugin with a Jest test setup, satisfying REQ-TYPESCRIPT, REQ-NPM-PACKAGE, and REQ-TEST-SETUP.
Given this evidence, the story 001.0-DEV-PLUGIN-SETUP is fully implemented and should be marked as PASSED even though the checklist in the story markdown has not been manually updated.</notes>
</traceability>