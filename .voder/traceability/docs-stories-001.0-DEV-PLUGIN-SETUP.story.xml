<?xml version="1.0" encoding="UTF-8"?>
<traceability>
  <specification>docs/stories/001.0-DEV-PLUGIN-SETUP.story.md</specification>
  <status>PASSED</status>
  <last_validated>2025-11-21T01:24:33.548Z</last_validated>
  <last_modified>2025-11-19T07:26:31.159Z</last_modified>
  <evidence>Story file:
- docs/stories/001.0-DEV-PLUGIN-SETUP.story.md defines requirements and acceptance criteria for the foundational ESLint plugin structure, including REQ-PLUGIN-STRUCTURE, REQ-ESLINT-COMPAT, REQ-RULE-REGISTRY, REQ-CONFIG-SYSTEM, REQ-NPM-PACKAGE, REQ-TYPESCRIPT, REQ-TEST-SETUP, and REQ-ERROR-HANDLING.

Core plugin implementation:
- src/index.ts implements the plugin entry point in TypeScript:
  - Exports rules and configs and a default object:
    - `export { rules, configs };`
    - `export default { rules, configs };`
  - Dynamically loads rules from src/rules via a RULE_NAMES registry:
    ```ts
    const RULE_NAMES = [
      "require-story-annotation",
      "require-req-annotation",
      "require-branch-annotation",
      "valid-annotation-format",
      "valid-story-reference",
      "valid-req-reference",
    ] as const;
    const rules: Record<RuleName, Rule.RuleModule> = {} as any;
    RULE_NAMES.forEach((name) => {
      try {
        const mod = require(`./rules/${name}`);
        rules[name] = mod.default ?? mod;
      } catch (error: any) {
        console.error(
          `[eslint-plugin-traceability] Failed to load rule "${name}": ${error.message}`,
        );
        rules[name] = {
          meta: {
            type: "problem",
            docs: { description: `Failed to load rule '${name}'` },
            schema: [],
          },
          create(context: Rule.RuleContext) {
            return {
              Program(node: any) {
                context.report({
                  node,
                  message: `eslint-plugin-traceability: Error loading rule "${name}": ${error.message}`,
                });
              },
            };
          },
        } as Rule.RuleModule;
      }
    });
    ```
  - Provides `configs` with `recommended` and `strict` presets that reference the plugin rules.
  - Has JSDoc traceability linking to this story and requirements:
    ```ts
    /**
     * ESLint Traceability Plugin
     * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
     * @req REQ-PLUGIN-STRUCTURE - Provide foundational plugin export and registration
     * @req REQ-ERROR-HANDLING - Gracefully handles plugin loading errors and missing dependencies
     */
    ```
- src/rules directory contains all rule implementations referenced in RULE_NAMES:
  - require-branch-annotation.ts
  - require-req-annotation.ts
  - require-story-annotation.ts
  - valid-annotation-format.ts
  - valid-req-reference.ts
  - valid-story-reference.ts
  This satisfies REQ-RULE-REGISTRY (mechanism to register and load multiple rules).

ESLint v9 flat config integration:
- eslint.config.js uses ESLint v9 flat config format (array of config objects) and integrates the plugin:
  ```js
  const typescriptParser = require("@typescript-eslint/parser");
  const js = require("@eslint/js");
  let plugin;
  try {
    plugin = require("./src/index.js");
  } catch (eSrc) {
    try {
      plugin = require("./lib/src/index.js");
    } catch (eLib) {
      const inCI = process.env.NODE_ENV === "ci" || process.env.CI === "true";
      if (inCI) {
        throw new Error(
          "Traceability plugin not found. Expected ./src/index.js or ./lib/src/index.js to be present in CI."
        );
      } else {
        console.warn("Traceability plugin not built yet, skipping traceability rules");
        plugin = {};
      }
    }
  }
  module.exports = [
    js.configs.recommended,
    { files: ["**/*.ts", "**/*.tsx"], languageOptions: { parser: typescriptParser, ... }, plugins: { ...(plugin.rules ? { traceability: plugin } : {}) }, rules: { ... } },
    { files: ["**/*.js", "**/*.jsx"], plugins: { ...(plugin.rules ? { traceability: plugin } : {}) }, rules: { ... } },
    { files: ["**/*.test.{js,ts,tsx}", "**/__tests__/**/*.{js,ts,tsx}"], ... },
    { ignores: ["lib/**", "node_modules/**", "coverage/**", ".cursor/**", "**/.cursor/**", ".voder/**", "docs/**", "*.md"] },
  ];
  ```
- This confirms compatibility with ESLint v9 flat config and shows graceful handling of missing plugin builds in CI vs local development (supports acceptance criteria for Integration and Error Handling, and REQ-ESLINT-COMPAT / REQ-ERROR-HANDLING).

Tests mapped to this story:
- tests/plugin-setup.test.ts:
  ```ts
  /**
   * Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-PLUGIN-STRUCTURE - plugin exports rules and configs
   */
  import plugin, { rules, configs } from "../src/index";
  describe("Traceability ESLint Plugin (Story 001.0-DEV-PLUGIN-SETUP)", () => {
    it("[REQ-PLUGIN-STRUCTURE] plugin exports rules and configs", () => {
      expect(rules).toBeDefined();
      expect(configs).toBeDefined();
      expect(typeof rules).toBe("object");
      expect(typeof configs).toBe("object");
      expect(plugin.rules).toBe(rules);
      expect(plugin.configs).toBe(configs);
    });
  });
  ```
  - Verifies core plugin export structure (Core Functionality, REQ-PLUGIN-STRUCTURE).

- tests/plugin-default-export-and-configs.test.ts:
  ```ts
  /**
   * Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-PLUGIN-STRUCTURE - Validate plugin default export and configs in src/index.ts
   */
  import plugin, { rules, configs } from "../src/index";
  describe("Plugin Default Export and Configs (Story 001.0-DEV-PLUGIN-SETUP)", () => {
    it("[REQ-PLUGIN-STRUCTURE] default export includes rules and configs", () => {
      expect(plugin.rules).toBe(rules);
      expect(plugin.configs).toBe(configs);
    });
    it("[REQ-PLUGIN-STRUCTURE] rules object has correct rule names", () => {
      const expected = [
        "require-story-annotation",
        "require-req-annotation",
        "require-branch-annotation",
        "valid-annotation-format",
        "valid-story-reference",
        "valid-req-reference",
      ];
      const actual = Object.keys(rules);
      expect(actual).toEqual(expected);
    });
    it("[REQ-RULE-REGISTRY] configs.recommended contains correct rule configuration", () => {
      const recommendedRules = configs.recommended[0].rules;
      expect(recommendedRules).toHaveProperty("traceability/require-story-annotation", "error");
      expect(recommendedRules).toHaveProperty("traceability/require-req-annotation", "error");
      expect(recommendedRules).toHaveProperty("traceability/require-branch-annotation", "error");
    });
    it("[REQ-CONFIG-SYSTEM] configs.strict contains same rules as recommended", () => {
      const strictRules = configs.strict[0].rules;
      expect(strictRules).toEqual(configs.recommended[0].rules);
    });
  });
  ```
  - Validates default export structure, rule registry contents, and config system (REQ-PLUGIN-STRUCTURE, REQ-RULE-REGISTRY, REQ-CONFIG-SYSTEM).

- tests/integration/cli-integration.test.ts:
  ```ts
  /**
   * Tests for CLI integration functionality
   * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-PLUGIN-STRUCTURE - Validate plugin registers via CLI
   */
  import { spawnSync } from "child_process";
  import path from "path";
  describe("[docs/stories/001.0-DEV-PLUGIN-SETUP.story.md] CLI Integration (traceability plugin)", () => {
    const eslintPkgDir = path.dirname(require.resolve("eslint/package.json"));
    const eslintCliPath = path.join(eslintPkgDir, "bin", "eslint.js");
    const configPath = path.resolve(__dirname, "../../eslint.config.js");
    const tests = [
      { name: "reports error when @story annotation is missing", code: "function foo() {}", rule: "traceability/require-story-annotation:error", expectedStatus: 1 },
      { name: "does not report error when @story annotation is present", code: `/**\n * @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md\n */\nfunction foo() {}`, rule: "traceability/require-story-annotation:error", expectedStatus: 0 },
      { name: "reports error when @req annotation is missing", code: "function bar() {}", rule: "traceability/require-req-annotation:error", expectedStatus: 1 },
      { name: "reports error when @story annotation uses path traversal and @req annotation uses path traversal", ... },
      { name: "reports error when @story annotation uses absolute path and @req annotation uses absolute path", ... },
    ];
    function runEslint(code: string, rule: string) { ... }
    it.each(tests)("[REQ-PLUGIN-STRUCTURE] $name", ({ code, rule, expectedStatus }) => {
      const result = runEslint(code, rule);
      expect(result.status).toBe(expectedStatus);
    });
  });
  ```
  - Confirms plugin registration and behavior via the ESLint CLI using eslint.config.js (Core Functionality, Integration, and REQ-ESLINT-COMPAT).

Error handling tests:
- tests/plugin-setup-error.test.ts:
  ```ts
  /**
   * Tests for: docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @story docs/stories/001.0-DEV-PLUGIN-SETUP.story.md
   * @req REQ-ERROR-HANDLING - Gracefully handles plugin loading errors and missing dependencies
   */
  describe("Traceability ESLint Plugin Error Handling (Story 001.0-DEV-PLUGIN-SETUP)", () => {
    beforeEach(() => {
      jest.resetModules();
      jest.spyOn(console, "error").mockImplementation(() => {});
      jest.mock("../src/rules/require-branch-annotation", () => {
        throw new Error("Test load error");
      });
    });
    afterEach(() => {
      (console.error as jest.Mock).mockRestore();
    });
    it("[REQ-ERROR-HANDLING] should report error loading rule and provide placeholder rule", () => {
      const plugin = require("../src/index");
      expect(console.error).toHaveBeenCalledWith(
        expect.stringContaining('Failed to load rule "require-branch-annotation": Test load error'),
      );
      const placeholderRule = plugin.rules["require-branch-annotation"];
      expect(placeholderRule).toBeDefined();
      expect(placeholderRule.meta.docs.description).toContain("Failed to load rule 'require-branch-annotation'");
      const fakeContext = { report: jest.fn() };
      const visitor = placeholderRule.create(fakeContext as any);
      visitor.Program({ type: "Program" });
      expect(fakeContext.report).toHaveBeenCalledWith({
        node: { type: "Program" },
        message: expect.stringContaining('Error loading rule "require-branch-annotation": Test load error'),
      });
    });
  });
  ```
  - Directly validates REQ-ERROR-HANDLING and the Error Handling acceptance criterion.

- tests/cli-error-handling.test.ts (also tagged with this story and REQ-ERROR-HANDLING) uses the ESLint CLI and eslint.config.js, asserting non-zero exit and error output when simulating rule failure scenarios.

Test infrastructure:
- jest.config.js configures Jest with ts-jest, Node environment, and coverage. This is the testing infrastructure required by REQ-TEST-SETUP and is actively used by the tests above.

NPM package and TypeScript setup:
- package.json:
  - name: "eslint-plugin-traceability"
  - main: "lib/src/index.js"
  - types: "lib/src/index.d.ts"
  - files includes "lib", "README.md", "LICENSE" so the built plugin and typings are published.
  - devDependencies include TypeScript, ts-jest, eslint, @eslint/js, @typescript-eslint/parser, @typescript-eslint/utils, etc.
  - scripts include:
    - "build": "tsc -p tsconfig.json"
    - "type-check": "tsc --noEmit -p tsconfig.json"
    - "test": "jest --ci --bail"
  - This confirms the plugin is written in TypeScript, built to a publishable npm structure, and has proper test/setup scripts (REQ-TYPESCRIPT, REQ-NPM-PACKAGE, REQ-TEST-SETUP).

Documentation and user experience:
- README.md:
  - Provides installation instructions for npm and Yarn.
  - Shows example ESLint v9 flat config integration with the plugin.
  - Provides a Quick Start that demonstrates using `traceability.configs.recommended` in a flat config and running ESLint.
  - Lists available rules with links to rule-specific docs.
  - Describes how to run tests and quality checks.
- user-docs/eslint-9-setup-guide.md:
  - Detailed guide for setting up ESLint 9 with flat config.
  - Includes explicit section on enabling this plugin, demonstrating config usage and integration.
- docs/eslint-plugin-development-guide.md:
  - Internal developer guide for plugin structure, rule development, and meta information.
- Together, these satisfy the "User Experience" and "Documentation" acceptance criteria in the story.

Test execution evidence:
- Global test run (from earlier step):
  - Command: `npm test -- --runInBand --verbose`
  - Jest invoked as `jest --ci --bail --runInBand --verbose`.
  - Output showed debug logs from rules but no failures or non-zero exit status indicated by the tool, thus tests (including those tied to this story) are passing.
- Targeted test run for this story's tests:
  - Command:
    `npm test -- --runInBand --verbose tests/plugin-setup.test.ts tests/plugin-default-export-and-configs.test.ts tests/integration/cli-integration.test.ts tests/plugin-setup-error.test.ts tests/cli-error-handling.test.ts`
  - Jest ran with these test paths; the tool output indicates normal completion with no failures.
  - Confirms that the plugin loads, registers rules, integrates with ESLint CLI, and handles errors as required.</evidence>
  <notes>All acceptance criteria for docs/stories/001.0-DEV-PLUGIN-SETUP.story.md are met. The ESLint plugin is implemented in TypeScript with a standard Node.js module structure, exports rule and config registries, and is packaged as a proper npm plugin with build and type-check scripts. The plugin integrates with ESLint v9 flat config via eslint.config.js and is exercised through CLI integration tests. Error handling for rule load failures is explicitly implemented and verified by both unit and CLI-level tests. Comprehensive Jest-based tests referencing this story confirm plugin exports, rule registry correctness, configs, CLI behavior, and error handling. User and developer documentation (README, ESLint 9 setup guide, and development guide) provide clear instructions for installation, configuration, and development. Given the passing tests and traceable implementation, the story is fully implemented and passes.</notes>
</traceability>